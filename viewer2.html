<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Semantic Server: Live Transcript &amp; Notes</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

<!-- React & Framer Motion -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
        @layer base {
            html {
                font-family: 'Inter', sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1F1F24;
            --bg-tertiary: #303036;
            --text-primary: #F0F0F0;
            --text-secondary: #909096;
            --text-tertiary: #6C6C72;
            --accent-blue: #0A84FF;
            --border-color: #38383a;
            --green-live: #32D74B;
            --speaker-left-bg: #303036;
            --speaker-right-bg: #00407E;
            --button-blue-shadow-inner: rgba(10, 132, 255, 0.4);
            --button-blue-shadow-outer: rgba(0, 0, 0, 0.4);
            --button-end-shadow-inner: rgba(255, 69, 58, 0.4);
            --button-end-bg: #FF3B30;
            --button-end-hover-bg: #FF453A;
            --neo-shadow-light: rgba(70, 70, 75, 0.5);
            --neo-shadow-dark: rgba(0, 0, 0, 0.4);
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: var(--text-tertiary);
            border-radius: 10px;
        }
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: var(--text-tertiary) transparent;
        }
    </style>
</head>
<body class="bg-[var(--bg-primary)] text-[var(--text-primary)] min-h-screen flex flex-col text-sm">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const { motion, AnimatePresence } = window.Motion;

    // --- INITIAL DATA ---
    const INITIAL_DATA = [
        { id: 'live', items: [] },
        { id: 'marked', items: [] }
    ];

    function App() {
        const [studentName, setStudentName] = useState("Unknown");
        const [connectionStatus, setConnectionStatus] = useState("Disconnected");
        const [items, setItems] = useState(INITIAL_DATA);
        const [notes, setNotes] = useState("");
        const [ws, setWs] = useState(null);
        const [existingStudents, setExistingStudents] = useState([]);
        const [isExportOpen, setIsExportOpen] = useState(false);
        const [isAnalysisOpen, setIsAnalysisOpen] = useState(false);
        const [currentAnalysisData, setCurrentAnalysisData] = useState(null);
        const [pendingCardItem, setPendingCardItem] = useState(null);
        const [analysisLoading, setAnalysisLoading] = useState(false);

        const itemsRef = useRef(INITIAL_DATA);
        const studentNameRef = useRef(studentName);

        // Sync Refs
        useEffect(() => { itemsRef.current = items; }, [items]);
        useEffect(() => { studentNameRef.current = studentName; }, [studentName]);

        // --- WEBSOCKET SETUP ---
        useEffect(() => {
            const socket = new WebSocket("ws://localhost:8765");
            setWs(socket);

            socket.onopen = () => {
                setConnectionStatus("Connected");
                socket.send(JSON.stringify({
                    message_type: "start_session",
                    student_name: studentNameRef.current || "Unknown"
                }));
            };
            socket.onclose = () => setConnectionStatus("Disconnected");
            socket.onerror = () => setConnectionStatus("Error");

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.message_type === "partial") {
                    handlePartial(data.text);
                } else if (data.message_type === "transcript") {
                    handleFinal(data);
                } else if (data.message_type === "student_list") {
                    setExistingStudents(data.students);
                } else if (data.message_type === "analysis_result") {
                    setAnalysisLoading(false);
                    setCurrentAnalysisData(prev => ({
                        ...prev,
                        ...data.result,
                        category: prev?.category && prev.category !== 'VOCAB_GAP' ? prev.category : data.result.category
                    }));
                }
            };

            return () => socket.close();
        }, []);

        // --- HANDLERS ---
        const handlePartial = (text) => {
            setItems(prev => {
                const newItems = [...prev];
                const liveList = [...newItems[0].items];
                const lastItem = liveList[liveList.length - 1];

                if (lastItem && lastItem.isPartial) {
                    liveList[liveList.length - 1] = { ...lastItem, text: text + "..." };
                } else {
                    liveList.push({
                        id: 'partial-' + Date.now(),
                        text: text + "...",
                        isPartial: true,
                        speaker: null
                    });
                }
                newItems[0] = { ...newItems[0], items: liveList };
                return newItems;
            });
        };

        const handleFinal = (data) => {
            setItems(prev => {
                const newItems = [...prev];
                let liveList = [...newItems[0].items];
                const partialIndex = liveList.findIndex(item => item.isPartial);

                const newItem = {
                    id: 'turn-' + data.turn_order,
                    text: data.text,
                    speaker: data.speaker || "Unknown",
                    isPartial: false,
                    fullData: data,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                if (partialIndex !== -1) {
                    liveList[partialIndex] = newItem;
                } else {
                    liveList.push(newItem);
                }

                newItems[0] = { ...newItems[0], items: liveList };
                return newItems;
            });
        };

        const handleCardClick = (item) => {
            if (item.isPartial) return;
            setPendingCardItem(item);
            setIsAnalysisOpen(true);
            setAnalysisLoading(true);
            setCurrentAnalysisData({
                detectedTrigger: item.text,
                category: 'VOCAB_GAP'
            });

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    message_type: "analyze_turn",
                    text: item.text,
                    turn_id: item.id
                }));
            } else {
                setAnalysisLoading(false);
            }
        };

        const handleAnalysisSave = (formData) => {
            if (!pendingCardItem) return;
            setItems(prev => {
                const newItems = [...prev];
                newItems[1].items.push({
                    ...pendingCardItem,
                    id: pendingCardItem.id + '-card-' + Date.now(),
                    analysis: formData
                });
                return newItems;
            });
            setIsAnalysisOpen(false);
            setPendingCardItem(null);
        };

        const handleEndSession = () => {
            if (confirm("Are you sure you want to end the session?")) {
                if (ws) ws.close();
                setConnectionStatus("Ended");
            }
        };

        const handleExport = (format) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ message_type: "export_session", format }));
            }
            setIsExportOpen(false);
        };


        return (
            <div className="min-h-screen flex flex-col text-sm">
                <header className="px-6 py-3 bg-[#161618]/80 backdrop-blur-xl flex items-center justify-between sticky top-0 z-20 border-b border-[var(--border-color)]">
                    <div className="flex items-center space-x-4">
                        <h1 className="text-xl font-semibold text-[var(--text-primary)]">Semantic Server</h1>
                        <div className="h-6 w-px bg-[var(--border-color)]"></div>
                         <select
                            className="appearance-none bg-transparent text-sm font-medium text-gray-300 pl-2 pr-6 py-1 cursor-pointer focus:outline-none hover:text-white transition-colors"
                            value={studentName}
                            onChange={(e) => setStudentName(e.target.value)}
                         >
                            <option value="Unknown" disabled>Select Student...</option>
                            {existingStudents.map(s => <option key={s} value={s} style={{backgroundColor: 'var(--bg-secondary)', color: 'white'}}>{s}</option>)}
                        </select>
                    </div>
                    <div className="flex items-center space-x-4">
                        <div className="flex items-center space-x-2">
                            <div className="relative flex h-3 w-3">
                                {connectionStatus === 'Connected' && <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--green-live)] opacity-75"></span>}
                                <span className={`relative inline-flex rounded-full h-3 w-3 ${connectionStatus === 'Connected' ? 'bg-[var(--green-live)]' : 'bg-red-500'}`}></span>
                            </div>
                            <span className={`font-medium tracking-wider text-xs uppercase ${connectionStatus === 'Connected' ? 'text-[var(--green-live)]' : 'text-red-500'}`}>
                                {connectionStatus === 'Connected' ? 'LIVE' : connectionStatus.toUpperCase()}
                            </span>
                        </div>
                        <button onClick={() => setIsExportOpen(true)} className="px-4 py-2 text-sm bg-gradient-to-br from-[#404046] to-[#252528] text-[var(--text-primary)] font-medium rounded-lg border border-[#48484A] shadow-[inset_0_1px_1px_rgba(255,255,255,0.08),_0_2px_4px_rgba(0,0,0,0.5)] hover:from-[#48484E] hover:to-[#2D2D30] transition-all flex items-center space-x-2">
                            <span className="material-symbols-outlined text-base" style={{fontVariationSettings: "'wght' 300, 'FILL' 0"}}>ios_share</span>
                            <span>Export</span>
                        </button>
                        <button onClick={handleEndSession} className="px-5 py-2 text-sm bg-[var(--button-end-bg)] text-white font-semibold rounded-lg shadow-[inset_0_1px_1px_var(--button-end-shadow-inner),_0_2px_4px_var(--button-blue-shadow-outer)] hover:bg-[var(--button-end-hover-bg)] transition-all">End Session</button>
                    </div>
                </header>

                <main className="flex-grow grid grid-cols-12 gap-6 p-6">
                    <div className="col-span-8 flex flex-col gap-6">
                        <section className="flex-grow bg-[var(--bg-secondary)] rounded-2xl border border-[#2D2D31] p-6 flex flex-col shadow-[inset_0_1px_2px_var(--neo-shadow-light),_0_8px_24px_var(--neo-shadow-dark)]">
                           <TranscriptList items={items[0].items} onCardClick={handleCardClick} />
                        </section>
                    </div>
                    <aside className="col-span-4 bg-[var(--bg-secondary)] rounded-2xl border border-[#2D2D31] p-6 flex flex-col shadow-[inset_0_1px_2px_var(--neo-shadow-light),_0_8px_24px_var(--neo-shadow-dark)]">
                        <h2 className="text-lg font-semibold text-[var(--text-primary)] mb-6">Actionable Items & Notes</h2>
                        <div className="flex-grow flex flex-col">
                            <div className="flex-1 space-y-2 overflow-y-auto scrollbar-thin pr-2 -mr-2">
                               {items[1].items.map(item => <TaskItem key={item.id} item={item} />)}
                            </div>
                            <textarea
                                className="w-full h-48 mt-4 bg-[#2A2A2F] border border-[#3A3A3F] p-4 text-[var(--text-primary)] rounded-xl resize-none placeholder-[var(--text-tertiary)] focus:ring-1 focus:ring-[var(--accent-blue)] focus:outline-none scrollbar-thin leading-relaxed"
                                placeholder="Start typing your notes..."
                                value={notes}
                                onChange={(e) => setNotes(e.target.value)}
                            ></textarea>
                        </div>
                        <div className="mt-4 pt-4 border-t border-[var(--border-color)] flex items-center justify-end">
                            <span className="text-xs text-[var(--text-tertiary)]">Saved automatically</span>
                        </div>
                    </aside>
                </main>
                <ExportModal
                    isOpen={isExportOpen}
                    onClose={() => setIsExportOpen(false)}
                    onExport={handleExport}
                />
                <AnalysisModal
                    isOpen={isAnalysisOpen}
                    onClose={() => setIsAnalysisOpen(false)}
                    onSave={handleAnalysisSave}
                    isLoading={analysisLoading}
                    initialData={currentAnalysisData}
                />
            </div>
        );
    }

    function TranscriptList({ items, onCardClick }) {
        const bottomRef = useRef(null);
        useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: "smooth" }); }, [items]);

        return (
            <div className="flex-1 space-y-6 overflow-y-auto scrollbar-thin pr-3 -mr-3">
                {items.map((item, index) => (
                    <TranscriptItem key={item.id || index} item={item} onClick={() => onCardClick(item)} />
                ))}
                <div ref={bottomRef} />
            </div>
        );
    }

    function TranscriptItem({ item, onClick }) {
        const isTutor = item.speaker && (item.speaker.includes("Aaron") || item.speaker === "A"  || item.speaker === "Tutor");
        const speakerInitial = item.speaker ? item.speaker.charAt(0).toUpperCase() : 'U';

        if (item.isPartial) {
            return (
                <div className="flex justify-center py-2 opacity-50">
                    <span className="text-xs text-gray-500 animate-pulse font-mono">{item.text}</span>
                </div>
            );
        }

        const bubbleContent = (
            <div className={`space-y-1 ${isTutor ? 'flex flex-col items-end' : ''}`}>
                <p className={`p-3 rounded-lg max-w-xl shadow-md cursor-pointer ${isTutor ? 'bg-[var(--speaker-right-bg)] text-white' : 'bg-[var(--speaker-left-bg)]'}`} onClick={onClick}>
                    {item.text}
                </p>
            </div>
        );

        const flagButton = (
            <button onClick={onClick} className="invisible group-hover:visible w-7 h-7 flex items-center justify-center rounded-full bg-[#FF3B30] text-white shadow-lg transition-opacity shrink-0">
                <span className="material-symbols-outlined text-base" style={{fontVariationSettings: "'FILL' 1, 'wght' 500"}}>flag</span>
            </button>
        );

        const avatar = (
             <div className={`w-6 h-6 rounded-full ${isTutor ? 'bg-teal-400' : 'bg-indigo-400'} flex items-center justify-center text-xs font-bold text-white shrink-0`}>
                {speakerInitial}
            </div>
        );

        return (
            <div className={`group flex items-start gap-3 w-full ${isTutor ? 'justify-end' : 'justify-start'}`}>
                {isTutor ? (
                    <>
                        <div className="order-1">{flagButton}</div>
                        <div className="order-2">{bubbleContent}</div>
                        <div className="order-3">{avatar}</div>
                    </>
                ) : (
                    <>
                        {avatar}
                        {bubbleContent}
                        {flagButton}
                    </>
                )}
            </div>
        );
    }

    function TaskItem({ item }) {
        const analysis = item.analysis || {};
        return (
            <div className="group bg-[#1C1C1E] hover:bg-[#2C2C2E] rounded-xl p-3 border border-white/5 hover:border-blue-500/30 transition-all cursor-pointer">
                <div className="flex items-start justify-between mb-1">
                    <span className="text-[10px] font-bold text-blue-400 uppercase tracking-wider bg-blue-500/10 px-1.5 py-0.5 rounded">
                        {analysis.category || "TASK"}
                    </span>
                    <span className="text-[10px] text-gray-600 font-mono">{item.timestamp}</span>
                </div>
                <p className="text-sm text-gray-200 leading-snug">
                    {analysis.suggestedCorrection || item.text}
                </p>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    function AnalysisModal({ isOpen, onClose, onSave, isLoading, initialData }) {
        const [formData, setFormData] = useState({ category: 'VOCAB_GAP', suggestedCorrection: '', explanation: '', detectedTrigger: '' });

        useEffect(() => {
            if (initialData) setFormData(prev => ({ ...prev, ...initialData }));
        }, [initialData]);

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <motion.div 
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-2xl p-6 w-full max-w-md shadow-2xl shadow-black/50"
                >
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-semibold text-[var(--text-primary)]">Create Card</h3>
                        <button onClick={onClose} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)] material-symbols-outlined">close</button>
                    </div>

                    {isLoading ? (
                        <div className="py-8 flex flex-col items-center justify-center space-y-3">
                            <div className="w-6 h-6 border-2 border-[var(--accent-blue)] border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-sm text-[var(--text-secondary)]">Analyzing context...</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider ml-1">Original Text</label>
                                <div className="mt-1 p-3 bg-black/30 rounded-xl text-[var(--text-primary)] text-sm italic border border-[var(--border-color)]">
                                    "{formData.detectedTrigger}"
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider ml-1">Category</label>
                                    <select
                                        className="mt-1 w-full bg-[var(--bg-tertiary)] text-[var(--text-primary)] text-sm rounded-lg px-3 py-2.5 outline-none focus:ring-1 focus:ring-[var(--accent-blue)] border border-[var(--border-color)]"
                                        value={formData.category}
                                        onChange={e => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="VOCAB_GAP">Vocabulary</option>
                                        <option value="GRAMMAR_ERR">Grammar</option>
                                        <option value="PRONUNCIATION">Pronunciation</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider ml-1">Correction</label>
                                    <input
                                        className="mt-1 w-full bg-[var(--bg-tertiary)] text-[var(--text-primary)] text-sm rounded-lg px-3 py-2.5 outline-none focus:ring-1 focus:ring-[var(--accent-blue)] border border-[var(--border-color)]"
                                        value={formData.suggestedCorrection}
                                        onChange={e => setFormData({...formData, suggestedCorrection: e.target.value})}
                                        placeholder="Correction..."
                                    />
                                </div>
                            </div>

                            <div className="pt-4 flex justify-end space-x-3">
                                <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">Cancel</button>
                                <button onClick={() => onSave(formData)} className="px-6 py-2 bg-[var(--accent-blue)] hover:opacity-90 text-white text-sm font-semibold rounded-full shadow-lg shadow-blue-600/20 transition-all transform active:scale-95">
                                    Save Card
                                </button>
                            </div>
                        </div>
                    )}
                </motion.div>
            </div>
        );
    }

    function ExportModal({ isOpen, onClose, onExport }) {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                <motion.div
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-2xl p-6 w-80 shadow-2xl"
                >
                    <h3 className="text-lg font-semibold text-[var(--text-primary)] text-center mb-6">Export Session</h3>
                    <div className="space-y-3">
                        <button onClick={() => onExport('json')} className="w-full flex items-center justify-between p-4 bg-[var(--bg-tertiary)] hover:bg-opacity-80 rounded-xl transition-colors group">
                            <span className="font-medium text-[var(--text-primary)]">JSON Format</span>
                            <span className="material-symbols-outlined text-[var(--text-secondary)] group-hover:text-[var(--text-primary)]">data_object</span>
                        </button>
                        <button onClick={() => onExport('markdown')} className="w-full flex items-center justify-between p-4 bg-[var(--bg-tertiary)] hover:bg-opacity-80 rounded-xl transition-colors group">
                            <span className="font-medium text-[var(--text-primary)]">Markdown</span>
                            <span className="material-symbols-outlined text-[var(--text-secondary)] group-hover:text-[var(--text-primary)]">markdown</span>
                        </button>
                    </div>
                    <button onClick={onClose} className="w-full mt-6 text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">Cancel</button>
                </motion.div>
            </div>
        );
    }

</script>
</body></html>
