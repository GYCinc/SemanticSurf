<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Surfer | Crimson Glass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        body {
            background-color: #030303;
            color: #FFFFFF;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .no-drag { -webkit-app-region: no-drag; }
        .drag { -webkit-app-region: drag; }

        .app-header {
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px 0 120px; /* Strong offset for stoplights */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #eab308;
            margin-right: 8px;
        }
        .status-dot.active { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }

        .wpm-box {
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .word-token {
            display: inline-block;
            padding: 2px 4px;
            margin: 0 2px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .word-token.marked { background: rgba(220, 20, 60, 0.4); color: #ff4d4d; }

        .turn-container { margin-bottom: 24px; }
        .speaker-label { font-weight: 900; font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 4px; }

    </style>
</head>
<body class="bg-gradient-to-br from-[#450a0a] via-[#991b1b] to-[#450a0a]">

    <div id="root"></div>

    <!-- Whiteboard Pop-over -->
    <div id="wb-overlay">
        <div class="wb-toolbar">
            <div class="wb-title">Shared Canvas</div>
            <div class="wb-tools">
                <button class="wb-btn active">✏️</button>
                <div class="color-picker active" style="background: #fff;" onclick="currentColor='#fff'"></div>
                <div class="color-picker" style="background: #ef4444;" onclick="currentColor='#ef4444'"></div>
                <div class="color-picker" style="background: #3b82f6;" onclick="currentColor='#3b82f6'"></div>
            </div>
        </div>
        <div id="wb-canvas-container"></div>
    </div>

    <!-- Liveblocks SDK -->
    <script src="https://unpkg.com/@liveblocks/client"></script>
    <script src="ui/whiteboard.js"></script>
    <link rel="stylesheet" href="ui/whiteboard.css">

    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;
        const { motion, AnimatePresence } = window.Motion;

        const App = () => {
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            const [sessionState, setSessionState] = useState('idle'); // idle, running
            const [transcripts, setTranscripts] = useState([]);
            const [partialTranscript, setPartialTranscript] = useState('');
            const [wpm, setWpm] = useState(0);

            const ws = useRef(null);

            const connect = () => {
                ws.current = new WebSocket('ws://localhost:8765');
                ws.current.onopen = () => setIsConnected(true);
                ws.current.onclose = () => {
                    setIsConnected(false);
                    setTimeout(connect, 2000);
                };
                ws.current.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    switch (data.message_type) {
                        case 'student_list':
                            // If Sanity students are already loaded, don't overwrite them
                            if (students.length === 0) {
                                setStudents(data.students);
                            }
                            break;
                        case 'session_start':
                            setSessionState('running');
                            setTranscripts([]);
                            setPartialTranscript('');
                            break;
                        case 'transcript':
                            setTranscripts(prev => [...prev, data]);
                            setPartialTranscript('');
                            break;
                        case 'partial':
                            setPartialTranscript(data.text);
                            break;
                        case 'wpm':
                            setWpm(Math.round(data.wpm));
                            break;
                    }
                };
            };

            useEffect(() => {
                const loadSanityStudents = async () => {
                    try {
                        const sanityStudents = await window.electron.getSanityStudents();
                        if (sanityStudents && sanityStudents.length > 0) {
                            setStudents(sanityStudents.map(s => s.name));
                        }
                    } catch (e) {
                        console.error("Failed to load students from Sanity:", e);
                    }
                };

                loadSanityStudents();
                connect();
                return () => ws.current && ws.current.close();
            }, []);

            const startSession = () => {
                if (selectedStudent) {
                    ws.current.send(JSON.stringify({ message_type: 'start_session', student_name: selectedStudent }));
                }
            };

            const endSession = () => {
                ws.current.send(JSON.stringify({ message_type: 'end_session' }));
                setSessionState('idle');
            };

            return (
                <div className="flex flex-col h-screen">
                    <Header
                        students={students}
                        selectedStudent={selectedStudent}
                        onSelectStudent={setSelectedStudent}
                        isConnected={isConnected}
                        sessionState={sessionState}
                        onStart={startSession}
                        onEnd={endSession}
                        wpm={wpm}
                    />
                    <TranscriptFeed transcripts={transcripts} partialTranscript={partialTranscript} sessionState={sessionState} />
                </div>
            );
        };

        const Header = ({ students, selectedStudent, onSelectStudent, isConnected, sessionState, onStart, onEnd, wpm }) => {
             const [timer, setTimer] = useState(0);

            useEffect(() => {
                let interval;
                if (sessionState === 'running') {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                } else {
                    setTimer(0);
                }
                return () => clearInterval(interval);
            }, [sessionState]);

            const formatTime = (seconds) => new Date(seconds * 1000).toISOString().substr(11, 8);

            return (
                <header className="drag app-header flex items-center justify-between text-white z-30">
                    <div className="flex items-center gap-3">
                        <div className={`status-dot ${isConnected ? 'active' : ''}`}></div>
                        <span className="text-[10px] font-black tracking-widest opacity-50">SEMANTIC SURFER</span>
                    </div>
                    <div className="no-drag flex items-center gap-6">
                        <CustomSelect
                            options={students}
                            selected={selectedStudent}
                            onSelect={onSelectStudent}
                            placeholder="Select Student"
                            disabled={sessionState === 'running'}
                        />
                        <div className="wpm-box">
                            <span className="font-black text-lg">{wpm}</span>
                            <span className="text-[7px] font-black opacity-30 uppercase">WPM</span>
                        </div>
                         <div className="flex flex-col items-end w-20">
                            <span className="text-[7px] font-black opacity-30 uppercase">Timer</span>
                            <div className="text-xs font-mono font-bold text-white/60">{formatTime(timer)}</div>
                        </div>
                        {sessionState === 'idle' ? (
                            <button onClick={onStart} disabled={!selectedStudent} className="px-6 py-2 rounded-full bg-red-600/40 hover:bg-red-600/60 text-[10px] font-black uppercase transition-all disabled:opacity-50 disabled:cursor-not-allowed">Start</button>
                        ) : (
                            <button onClick={onEnd} className="px-6 py-2 rounded-full bg-white/10 hover:bg-white/20 text-[10px] font-black uppercase transition-all">End Session</button>
                        )}
                        <button onClick={() => window.toggleWhiteboard()} className="px-4 py-2 rounded-full bg-blue-600/20 hover:bg-blue-600/40 text-[10px] font-black uppercase transition-all border border-blue-500/30">Whiteboard</button>
                    </div>
                </header>
            );
        };

        const CustomSelect = ({ options, selected, onSelect, placeholder, disabled }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (ref.current && !ref.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [ref]);

            return (
                <div className="relative" ref={ref}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        disabled={disabled}
                        className="bg-black/20 border border-red-500/50 rounded-full px-4 py-1.5 text-[10px] font-black text-white/90 uppercase w-48 text-left truncate disabled:opacity-50"
                    >
                        {selected || placeholder}
                    </button>
                    <AnimatePresence>
                        {isOpen && (
                            <motion.div
                                initial={{ opacity: 0, y: -10 }}
                                animate={{ opacity: 1, y: 0 }}
                                exit={{ opacity: 0, y: -10 }}
                                className="absolute top-full mt-2 w-48 bg-[#1a0f0f] border border-red-500/50 rounded-lg shadow-lg z-10"
                            >
                                {options.map(option => (
                                    <div
                                        key={option}
                                        onClick={() => { onSelect(option); setIsOpen(false); }}
                                        className="px-4 py-2 text-xs font-bold hover:bg-red-800/50 cursor-pointer"
                                    >
                                        {option}
                                    </div>
                                ))}
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const TranscriptFeed = ({ transcripts, partialTranscript, sessionState }) => {
            const feedRef = useRef(null);

            useEffect(() => {
                if (feedRef.current) {
                    feedRef.current.scrollTop = feedRef.current.scrollHeight;
                }
            }, [transcripts, partialTranscript]);

            return (
                <main ref={feedRef} className="flex-grow pt-24 pb-10 px-12 overflow-y-auto">
                    {sessionState === 'idle' && (
                         <div className="h-full flex flex-col items-center justify-center opacity-30">
                            <div className="text-4xl font-black uppercase">Engine Ready</div>
                            <div className="text-xs tracking-[0.4em] uppercase mt-2">Select Student to Begin</div>
                        </div>
                    )}
                    <AnimatePresence>
                        {transcripts.map((t, i) => <TranscriptRow key={t.timestamp || i} {...t} />)}
                    </AnimatePresence>
                     {partialTranscript && (
                        <motion.div
                            initial={{ opacity: 0, scale: 0.98, y: 5 }}
                            animate={{ opacity: 1, scale: 1, y: 0 }}
                            className="turn-container"
                        >
                            <div className="speaker-label">...</div>
                            <div className="text-xl font-bold italic opacity-60">{partialTranscript}</div>
                        </motion.div>
                    )}
                </main>
            );
        };

        const TranscriptRow = ({ speaker, transcript, words }) => (
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ type: "spring", stiffness: 300, damping: 30 }}
                className="turn-container"
            >
                <div className="speaker-label">{speaker}</div>
                <p className="text-xl font-semibold leading-relaxed">
                    {words.map((word, i) => <TranscriptWord key={i} word={word} transcript={transcript} />)}
                </p>
            </motion.div>
        );

        const TranscriptWord = ({ word, transcript }) => {
            const [isMarked, setIsMarked] = useState(false);

            const handleClick = () => {
                setIsMarked(!isMarked);
                window.electron.saveCardToSanity({
                    category: 'RECAST',
                    detectedTrigger: word.text,
                    explanation: transcript,
                });
            };

            return (
                <motion.span
                    whileHover={{ scale: 1.1, y: -3, backgroundColor: 'rgba(255,255,255,0.1)' }}
                    transition={{ type: "spring", stiffness: 400, damping: 15 }}
                    className={`word-token ${isMarked ? 'marked' : ''}`}
                    onClick={handleClick}
                >
                    {word.text}{' '}
                </motion.span>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
