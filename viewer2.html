<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Project Sentinel: Liquid Glass</title>
    
    <!-- React & Framer Motion -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght,FILL@300,1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <style type="text/tailwindcss">
        @layer base {
            html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        }

        /* --- LIQUID GLASS THEME --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-highlight: rgba(255, 255, 255, 0.08);
            --text-glow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* Animated Background */
        .liquid-bg {
            background: radial-gradient(circle at 0% 0%, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-bubble {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .text-shadow-sm { text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .text-shadow-glow { text-shadow: 0 0 10px rgba(255,255,255,0.4); }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="liquid-bg text-white min-h-screen flex flex-col overflow-hidden">
    <!-- Overlay for slight darkening to improve text readability -->
    <div class="absolute inset-0 bg-black/30 pointer-events-none z-0"></div>

    <div id="root" class="flex flex-col h-screen relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- MODULE: DashboardClient (Networking Layer) ---
        class DashboardClient {
            constructor(url, handlers) {
                this.url = url;
                this.handlers = handlers;
                this.socket = null;
                this.reconnectInterval = 3000;
            }

            connect(studentName) {
                this.socket = new WebSocket(this.url);
                this.socket.onopen = () => {
                    this.handlers.onStatusChange("Connected");
                    this.socket.send(JSON.stringify({ message_type: "start_session", student_name: studentName }));
                };
                this.socket.onclose = () => {
                    this.handlers.onStatusChange("Disconnected");
                    setTimeout(() => this.connect(studentName), this.reconnectInterval);
                };
                this.socket.onerror = () => this.handlers.onStatusChange("Error");
                this.socket.onmessage = (event) => {
                    try { this.handleMessage(JSON.parse(event.data)); } catch (e) { console.error("Parse Error:", e); }
                };
            }

            handleMessage(data) {
                switch(data.message_type) {
                    case "partial": this.handlers.onPartial(data.text); break;
                    case "transcript": this.handlers.onTurn(data); break;
                    case "analysis_result": this.handlers.onAnalysis(data); break;
                    case "student_list": this.handlers.onStudentList(data.students); break;
                    case "system_health": this.handlers.onHealth(data.data); break;
                }
            }

            sendMessage(type, payload = {}) {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({ message_type: type, ...payload }));
                }
            }
        }

        // --- MODULE: StudentContext (State Management) ---
        const StudentContext = createContext();

        function StudentProvider({ children }) {
            const [studentName, setStudentName] = useState("Unknown");
            const [connectionStatus, setConnectionStatus] = useState("Disconnected");
            const [turns, setTurns] = useState([]);
            const [activeTurn, setActiveTurn] = useState(null);
            const [actionableTasks, setActionableTasks] = useState([]);
            const [studentsList, setStudentsList] = useState([]);
            const clientRef = useRef(null);

            useEffect(() => {
                const handlers = {
                    onStatusChange: setConnectionStatus,
                    onPartial: (text) => setActiveTurn({ text, isPartial: true }),
                    onTurn: (data) => {
                        setActiveTurn(null);
                        setTurns(prev => [...prev, { ...data, id: 'turn-' + Date.now() }]);
                    },
                    onAnalysis: (data) => {
                         if (data.result && !data.result.error) {
                             setActionableTasks(prev => [data.result, ...prev]);
                         }
                    },
                    onStudentList: setStudentsList,
                    onHealth: (data) => console.log("Health:", data)
                };

                clientRef.current = new DashboardClient("ws://localhost:8765", handlers);
                clientRef.current.connect(studentName);
                return () => { if(clientRef.current.socket) clientRef.current.socket.close(); };
            }, [studentName]);

            const analyzeTurn = (text, turnId) => {
                clientRef.current.sendMessage("analyze_turn", { text, turn_id: turnId });
            };

            const value = { studentName, setStudentName, connectionStatus, turns, activeTurn, actionableTasks, studentsList, analyzeTurn };
            return <StudentContext.Provider value={value}>{children}</StudentContext.Provider>;
        }

        // --- COMPONENTS ---

        function Header() {
            const { connectionStatus, studentName, setStudentName, studentsList } = useContext(StudentContext);

            return (
                <header className="px-8 py-5 flex items-center justify-between sticky top-0 z-20">
                    <div className="glass-panel rounded-full px-6 py-3 flex items-center space-x-6 backdrop-blur-xl bg-white/5 border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.1)]">
                        <h1 className="text-xl font-bold tracking-wider text-white text-shadow-glow">SEMANTIC SURFER</h1>

                        <div className={`flex items-center px-3 py-1 rounded-full text-[10px] font-bold tracking-widest uppercase ${connectionStatus === 'Connected' ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' : 'bg-red-500/20 text-red-300 border border-red-500/30'}`}>
                            {connectionStatus === 'Connected' ? 'ONLINE' : 'OFFLINE'}
                        </div>

                        <div className="h-4 w-px bg-white/20"></div>

                        <div className="relative group">
                            <select
                                className="appearance-none bg-transparent text-sm font-medium text-white/80 pl-2 pr-8 py-1 cursor-pointer focus:outline-none hover:text-white transition-colors"
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                            >
                                <option className="bg-gray-900" value="Unknown" disabled>Select Student...</option>
                                {studentsList.map(s => <option className="bg-gray-900" key={s} value={s}>{s}</option>)}
                            </select>
                            <span className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-white/50 material-symbols-rounded text-sm">expand_more</span>
                        </div>
                    </div>

                    <div className="flex items-center space-x-3">
                        <button className="glass-button rounded-full p-3 hover:bg-white/20 group">
                            <span className="material-symbols-rounded text-white/70 group-hover:text-white transition-colors">archive</span>
                        </button>
                        <button className="glass-button rounded-full p-3 hover:bg-white/20 group">
                            <span className="material-symbols-rounded text-white/70 group-hover:text-white transition-colors">settings</span>
                        </button>
                    </div>
                </header>
            );
        }

        function TaskCard({ task }) {
            return (
                <motion.div
                    initial={{ opacity: 0, x: 20, backdropFilter: "blur(0px)" }}
                    animate={{ opacity: 1, x: 0, backdropFilter: "blur(12px)" }}
                    className="glass-bubble rounded-2xl p-5 mb-4 group hover:bg-white/10 transition-all border border-white/10 hover:border-white/30"
                >
                    <div className="flex items-center justify-between mb-3">
                        <span className="text-[10px] font-bold text-cyan-300 uppercase tracking-widest bg-cyan-500/10 px-2 py-1 rounded border border-cyan-500/20 shadow-[0_0_10px_rgba(34,211,238,0.2)]">
                            {task.category || "General"}
                        </span>
                        <span className="material-symbols-rounded text-white/30 text-sm group-hover:text-white/80 transition-colors cursor-pointer">check_circle</span>
                    </div>
                    <div className="mb-2">
                        <p className="text-sm text-white font-medium leading-relaxed text-shadow-sm">{task.suggestedCorrection}</p>
                    </div>
                    <div>
                        <p className="text-xs text-white/60 font-light leading-relaxed">{task.explanation}</p>
                    </div>
                </motion.div>
            );
        }

        function ChatBubble({ turn, isPartial }) {
            const isTutor = turn.speaker && (turn.speaker === 'Aaron' || turn.speaker === 'A');
            return (
                <motion.div 
                    initial={{ opacity: 0, scale: 0.95, y: 10 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    className={`flex w-full mb-6 ${isTutor ? 'justify-end' : 'justify-start'}`}
                >
                    <div className={`max-w-[75%] flex flex-col ${isTutor ? 'items-end' : 'items-start'}`}>
                        <div className={`
                            px-6 py-4 rounded-3xl text-[15px] leading-relaxed backdrop-blur-md shadow-lg border border-white/10
                            ${isTutor 
                                ? 'bg-white/10 text-white rounded-tr-sm'
                                : 'bg-black/20 text-white/90 rounded-tl-sm'}
                            ${isPartial ? 'animate-pulse' : ''}
                        `}>
                            {turn.text}
                        </div>
                        <span className="text-[10px] font-bold text-white/40 uppercase tracking-widest mt-2 px-2">
                            {isTutor ? 'TUTOR' : 'STUDENT'}
                        </span>
                    </div>

        function Dashboard() {
            const { turns, activeTurn, actionableTasks } = useContext(StudentContext);
            const scrollRef = useRef(null);

            useEffect(() => {
                if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [turns, activeTurn]);

            return (
                <main className="flex-grow flex overflow-hidden px-8 pb-8 gap-6">
                    {/* LEFT: CHAT */}
                    <section className="flex-1 glass-panel rounded-[2.5rem] flex flex-col relative overflow-hidden">
                        <div className="flex-1 overflow-y-auto p-8 scrollbar-hide" ref={scrollRef}>
                            {turns.length === 0 && !activeTurn && (
                                <div className="h-full flex flex-col items-center justify-center text-white/20">
                                    <span className="material-symbols-rounded text-6xl mb-4">graphic_eq</span>
                                    <p className="text-sm font-light tracking-widest uppercase">Waiting for audio stream...</p>
                                </div>
                            )}
                            {turns.map((t) => <ChatBubble key={t.id} turn={t} />)}
                            {activeTurn && <ChatBubble turn={activeTurn} isPartial={true} />}
                        </div>

                        {/* INPUT BAR */}
                        <div className="p-6">
                            <div className="glass-bubble rounded-full px-6 py-4 flex items-center space-x-4">
                                <span className="material-symbols-rounded text-white/50 animate-pulse">mic</span>
                                <div className="h-1 flex-1 bg-white/10 rounded-full overflow-hidden">
                                    <div className="h-full w-1/3 bg-white/30 rounded-full animate-progress"></div>
                                </div>
                                <span className="text-xs text-white/40 font-mono">LISTENING</span>
                            </div>
                        </div>
                    </section>

                    {/* RIGHT: ACTIONABLE TASKS */}
                    <aside className="w-[400px] flex flex-col">
                        <div className="glass-panel rounded-[2.5rem] flex-1 flex flex-col overflow-hidden p-6">
                            <div className="flex items-center justify-between mb-6 px-2">
                                <h2 className="text-sm font-bold text-white tracking-widest uppercase text-shadow-glow">Analysis</h2>
                                <span className="bg-white/10 px-2 py-0.5 rounded-full text-[10px] font-bold text-white/60 border border-white/10">{actionableTasks.length}</span>
                            </div>

                            <div className="flex-1 overflow-y-auto scrollbar-hide -mx-2 px-2">
                                <AnimatePresence>
                                    {actionableTasks.map((task, i) => (
                                        <TaskCard key={i} task={task} />
                                    ))}
                                </AnimatePresence>
                                {actionableTasks.length === 0 && (
                                    <div className="mt-10 text-center opacity-30">
                                        <div className="w-16 h-16 border border-white/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span className="material-symbols-rounded text-2xl">auto_awesome</span>
                                        </div>
                                        <p className="text-xs font-light">AI insights will appear here</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>
                </main>
            );
        }

        function App() {
            return (
                <StudentProvider>
                    <div className="flex flex-col h-full relative z-10">
                        <Header />
                        <Dashboard />
                    </div>
                </StudentProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
