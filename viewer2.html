<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Semantic Server Dashboard - Premium</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<!-- React & Framer Motion Setup -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/framer-motion@10.16.4/dist/framer-motion.umd.min.js"></script>
<!-- Liveblocks SDK for Whiteboard -->
<script src="https://unpkg.com/@liveblocks/client"></script>
<link rel="stylesheet" href="ui/whiteboard.css">


<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#f97316", // Orange-500, visible in both modes
                        "background-light": "#fff7ed", // Orange-50
                        "background-dark": "#0f0502", // Very dark orange/black
                        glass: {
                            light: "rgba(255, 255, 255, 0.25)",
                            dark: "rgba(0, 0, 0, 0.3)",
                            border: "rgba(255, 255, 255, 0.3)",
                            highlight: "rgba(255, 255, 255, 0.5)",
                        }
                    },
                    fontFamily: {
                        display: ["'Plus Jakarta Sans'", "sans-serif"],
                        body: ["'Plus Jakarta Sans'", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        '3xl': "1.5rem",
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.25)',
                        'glass-inset': 'inset 0 1px 0 0 rgba(255, 255, 255, 0.3)',
                        'glass-deep': '0 20px 40px -10px rgba(0,0,0,0.5)',
                        'glow': '0 0 20px rgba(249, 115, 22, 0.4)',
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                },
            },
        };
    </script>
<style>body {background: radial-gradient(circle at 50% 0%, #ea580c 0%, #9a3412 40%, #431407 80%, #0f0502 100%);
            min-height: 100vh;
            color: white;
            -webkit-font-smoothing: antialiased;
        }
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow:
                0 4px 30px rgba(0, 0, 0, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        .glass-panel-deep {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.1));
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }.no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }@keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px #22c55e, 0 0 10px #22c55e; }
            50% { box-shadow: 0 0 2px #22c55e, 0 0 5px #22c55e; }
        }
        .status-dot {
            animation: pulse-glow 2s infinite;
        }.text-gradient {
            background: linear-gradient(to bottom, #ffffff, #fed7aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .no-drag { -webkit-app-region: no-drag; }
        .drag { -webkit-app-region: drag; }
    </style>
</head>
<body class="font-display antialiased selection:bg-orange-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.framerMotion;

        //================================================================================
        // WebSocket and State Management Hook
        //================================================================================
        const useSemanticSocket = () => {
            const [isConnected, setIsConnected] = useState(false);
            const [students, setStudents] = useState([]);
            const [sessionStatus, setSessionStatus] = useState('idle'); // idle, active, ended
            const [transcript, setTranscript] = useState([]);
            const [markedItems, setMarkedItems] = useState([]);
            const ws = useRef(null);

            const connect = useCallback(() => {
                ws.current = new WebSocket('ws://localhost:8765');
                ws.current.onopen = () => setIsConnected(true);
                ws.current.onclose = () => {
                    setIsConnected(false);
                    setTimeout(connect, 2000);
                };
                ws.current.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    switch (data.message_type) {
                        case 'student_list':
                            // Simulating sanity load for now
                            // setStudents(data.students);
                            break;
                        case 'session_start':
                            setSessionStatus('active');
                            setTranscript([]);
                            setMarkedItems([]);
                            break;
                        case 'transcript':
                             setTranscript(prev => [...prev, {...data, id: Date.now()}]);
                            break;
                    }
                };
            }, []);

    </style>
</head>
<body class="bg-gradient-to-br from-[#450a0a] via-[#991b1b] to-[#450a0a]">

    <div id="root"></div>

    <!-- Whiteboard Pop-over -->
    <div id="wb-overlay">
        <div class="wb-toolbar">
            <div class="wb-title">Shared Canvas</div>
            <div class="wb-tools">
                <button class="wb-btn active">✏️</button>
                <div class="color-picker active" style="background: #fff;" onclick="currentColor='#fff'"></div>
                <div class="color-picker" style="background: #ef4444;" onclick="currentColor='#ef4444'"></div>
                <div class="color-picker" style="background: #3b82f6;" onclick="currentColor='#3b82f6'"></div>
            </div>
        </div>
        <div id="wb-canvas-container"></div>
    </div>

    <!-- Liveblocks SDK -->
    <script src="https://unpkg.com/@liveblocks/client"></script>
    <script src="ui/whiteboard.js"></script>
    <link rel="stylesheet" href="ui/whiteboard.css">

    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;
        const { motion, AnimatePresence } = window.Motion;

        const App = () => {
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            const [sessionState, setSessionState] = useState('idle'); // idle, running
            const [transcripts, setTranscripts] = useState([]);
            const [partialTranscript, setPartialTranscript] = useState('');
            const [wpm, setWpm] = useState(0);

            const ws = useRef(null);

            const connect = () => {
                ws.current = new WebSocket('ws://localhost:8765');
                ws.current.onopen = () => setIsConnected(true);
                ws.current.onclose = () => {
                    setIsConnected(false);
                    setTimeout(connect, 2000);
                };
                ws.current.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    switch (data.message_type) {
                        case 'student_list':
                            // If Sanity students are already loaded, don't overwrite them
                            if (students.length === 0) {
                                setStudents(data.students);
                            }
                            break;
                        case 'session_start':
                            setSessionState('running');
                            setTranscripts([]);
                            setPartialTranscript('');
                            break;
                        case 'transcript':
                            setTranscripts(prev => [...prev, data]);
                            setPartialTranscript('');
                            break;
                        case 'partial':
                            setPartialTranscript(data.text);
                            break;
                        case 'wpm':
                            setWpm(Math.round(data.wpm));
                            break;
                    }
                };
            };

            useEffect(() => {
                const loadSanityStudents = async () => {
                    try {
                        const sanityStudents = await window.electron.getSanityStudents();
                        if (sanityStudents && sanityStudents.length > 0) {
                            setStudents(sanityStudents.map(s => s.name));
                        }
                    } catch (e) {
                        console.error("Failed to load students from Sanity:", e);
                    }
                };

                loadSanityStudents();
                connect();
                return () => ws.current && ws.current.close();
            }, []);

            const startSession = () => {
                if (selectedStudent) {
                    ws.current.send(JSON.stringify({ message_type: 'start_session', student_name: selectedStudent }));
                }
            };

            const endSession = () => {
                ws.current.send(JSON.stringify({ message_type: 'end_session' }));
                setSessionState('idle');
            };

            return (
                <div className="flex flex-col h-screen">
                    <Header
                        students={students}
                        selectedStudent={selectedStudent}
                        onSelectStudent={setSelectedStudent}
                        isConnected={isConnected}
                        sessionState={sessionState}
                        onStart={startSession}
                        onEnd={endSession}
                        wpm={wpm}
                    />
                    <TranscriptFeed transcripts={transcripts} partialTranscript={partialTranscript} sessionState={sessionState} />
                </div>
            );
        };

        const Header = ({ students, selectedStudent, onSelectStudent, isConnected, sessionState, onStart, onEnd, wpm }) => {
             const [timer, setTimer] = useState(0);

            useEffect(() => {
                let interval;
                if (sessionState === 'running') {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                } else {
                    setTimer(0);
                }
                return () => clearInterval(interval);
            }, [sessionState]);

            const formatTime = (seconds) => new Date(seconds * 1000).toISOString().substr(11, 8);

            return (
                <header className="drag app-header flex items-center justify-between text-white z-30">
                    <div className="flex items-center gap-3">
                        <div className={`status-dot ${isConnected ? 'active' : ''}`}></div>
                        <span className="text-[10px] font-black tracking-widest opacity-50">SEMANTIC SURFER</span>
                    </div>
                    <div className="no-drag flex items-center gap-6">
                        <CustomSelect
                            options={students}
                            selected={selectedStudent}
                            onSelect={onSelectStudent}
                            placeholder="Select Student"
                            disabled={sessionState === 'running'}
                        />
                        <div className="wpm-box">
                            <span className="font-black text-lg">{wpm}</span>
                            <span className="text-[7px] font-black opacity-30 uppercase">WPM</span>
                        </div>
                         <div className="flex flex-col items-end w-20">
                            <span className="text-[7px] font-black opacity-30 uppercase">Timer</span>
                            <div className="text-xs font-mono font-bold text-white/60">{formatTime(timer)}</div>
                        </div>
                        {sessionState === 'idle' ? (
                            <button onClick={onStart} disabled={!selectedStudent} className="px-6 py-2 rounded-full bg-red-600/40 hover:bg-red-600/60 text-[10px] font-black uppercase transition-all disabled:opacity-50 disabled:cursor-not-allowed">Start</button>
                        ) : (
                            <button onClick={onEnd} className="px-6 py-2 rounded-full bg-white/10 hover:bg-white/20 text-[10px] font-black uppercase transition-all">End Session</button>
                        )}
                        <button onClick={() => window.toggleWhiteboard()} className="px-4 py-2 rounded-full bg-blue-600/20 hover:bg-blue-600/40 text-[10px] font-black uppercase transition-all border border-blue-500/30">Whiteboard</button>
                    </div>
                </header>
            );
        };

        const CustomSelect = ({ options, selected, onSelect, placeholder, disabled }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (ref.current && !ref.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [ref]);

            return (
                <div className="relative" ref={ref}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        disabled={disabled}
                        className="bg-black/20 border border-red-500/50 rounded-full px-4 py-1.5 text-[10px] font-black text-white/90 uppercase w-48 text-left truncate disabled:opacity-50"
                    >
                        {selected || placeholder}
                    </button>
                    <AnimatePresence>
                        {isOpen && (
                            <motion.div
                                initial={{ opacity: 0, y: -10 }}
                                animate={{ opacity: 1, y: 0 }}
                                exit={{ opacity: 0, y: -10 }}
                                className="absolute top-full mt-2 w-48 bg-[#1a0f0f] border border-red-500/50 rounded-lg shadow-lg z-10"
                            >
                                {options.map(option => (
                                    <div
                                        key={option}
                                        onClick={() => { onSelect(option); setIsOpen(false); }}
                                        className="px-4 py-2 text-xs font-bold hover:bg-red-800/50 cursor-pointer"
                                    >
                                        {option}
                                    </div>
                                ))}
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const TranscriptFeed = ({ transcripts, partialTranscript, sessionState }) => {
            const feedRef = useRef(null);

            useEffect(() => {
                if (feedRef.current) {
                    feedRef.current.scrollTop = feedRef.current.scrollHeight;
                }
            }, [transcripts, partialTranscript]);

            return (
                <main ref={feedRef} className="flex-grow pt-24 pb-10 px-12 overflow-y-auto">
                    {sessionState === 'idle' && (
                         <div className="h-full flex flex-col items-center justify-center opacity-30">
                            <div className="text-4xl font-black uppercase">Engine Ready</div>
                            <div className="text-xs tracking-[0.4em] uppercase mt-2">Select Student to Begin</div>
                        </div>
                    )}
                    <AnimatePresence>
                        {transcripts.map((t, i) => <TranscriptRow key={t.timestamp || i} {...t} />)}
                    </AnimatePresence>
                     {partialTranscript && (
                        <motion.div
                            initial={{ opacity: 0, scale: 0.98, y: 5 }}
                            animate={{ opacity: 1, scale: 1, y: 0 }}
                            className="turn-container"
                        >
                            <div className="speaker-label">...</div>
                            <div className="text-xl font-bold italic opacity-60">{partialTranscript}</div>
                        </motion.div>
                    )}
                </main>
            );
        };

        const TranscriptRow = ({ speaker, transcript, words }) => (
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ type: "spring", stiffness: 300, damping: 30 }}
                className="turn-container"
            >
                <div className="speaker-label">{speaker}</div>
                <p className="text-xl font-semibold leading-relaxed">
                    {words.map((word, i) => <TranscriptWord key={i} word={word} transcript={transcript} />)}
                </p>
            </motion.div>
        );

        const TranscriptWord = ({ word, transcript }) => {
            const [isMarked, setIsMarked] = useState(false);

            const handleClick = () => {
                setIsMarked(!isMarked);
                window.electron.saveCardToSanity({
                    category: 'RECAST',
                    detectedTrigger: word.text,
                    explanation: transcript,
                });
            };

            return (
                <motion.span
                    whileHover={{ scale: 1.1, y: -3, backgroundColor: 'rgba(255,255,255,0.1)' }}
                    transition={{ type: "spring", stiffness: 400, damping: 15 }}
                    className={`word-token ${isMarked ? 'marked' : ''}`}
                    onClick={handleClick}
                >
                    {word.text}{' '}
                </motion.span>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <div class="fixed inset-0 pointer-events-none opacity-[0.03] z-50 mix-blend-overlay" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDNl3_DqT-ELD6b3RK1kCGhfK8EJki5FtAqnmXoXNcIghL8O6g5O2CMQ6UiXJHhEf1h85GFQbRuZhEJvlErqReUSP29jENFSEYTcvwBmlZfJYdVy0JD-yjWhdYhzi_mdakKxzDXwXpYxw7k-s5kRiRf2zRj5-uM2gI2E9pEFAg5G2elDgS8bvjoq9UeXsC6ni-Uh8lQzvSXDoTtM0jFM7yoRpazOPb9ROwarBJ-jk8JbpJgeNgOUUHskpQs1cfO5Sn7gEz5XihZ4ng');"></div>
</body>
</html>
