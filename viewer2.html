<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Project Sentinel Dashboard</title>
    
    <!-- React & Framer Motion -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght,FILL@300,1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <style type="text/tailwindcss">
        @layer base {
            html {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }
        }
        :root {
            --bg-primary: #000000;
            --glass-panel: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --bubble-sent: #0A84FF;
            --bubble-received: #1C1C1E;
        }

        /* Apple-style Glassmorphism */
        .glass-panel {
            background-color: var(--glass-panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .glass-button {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        .glass-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .glass-button:active {
            transform: scale(0.98);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white">
    <div id="root" class="flex flex-col h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- INITIAL DATA ---
        const INITIAL_DATA = [
            { id: 'live', items: [] },
            { id: 'marked', items: [] }
        ];

        function App() {
            const [studentName, setStudentName] = useState("Unknown");
            const [connectionStatus, setConnectionStatus] = useState("Disconnected");
            const [items, setItems] = useState(INITIAL_DATA);
            const [notes, setNotes] = useState("");
            const [ws, setWs] = useState(null);
            const [existingStudents, setExistingStudents] = useState([]);
            
            // Modals
            const [isExportOpen, setIsExportOpen] = useState(false);
            const [isAnalysisOpen, setIsAnalysisOpen] = useState(false);
            const [currentAnalysisData, setCurrentAnalysisData] = useState(null);
            const [pendingCardItem, setPendingCardItem] = useState(null);
            const [analysisLoading, setAnalysisLoading] = useState(false);

            const itemsRef = useRef(INITIAL_DATA);
            const studentNameRef = useRef(studentName);

            // Sync Refs
            useEffect(() => { itemsRef.current = items; }, [items]);
            useEffect(() => { studentNameRef.current = studentName; }, [studentName]);

            // --- WEBSOCKET SETUP ---
            useEffect(() => {
                const socket = new WebSocket("ws://localhost:8765");
                setWs(socket);

                socket.onopen = () => {
                    setConnectionStatus("Connected");
                    socket.send(JSON.stringify({
                        message_type: "start_session",
                        student_name: studentNameRef.current || "Unknown"
                    }));
                };

                socket.onclose = () => setConnectionStatus("Disconnected");
                socket.onerror = () => setConnectionStatus("Error");

                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.message_type === "partial") {
                        handlePartial(data.text);
                    } else if (data.message_type === "transcript") {
                        handleFinal(data);
                    } else if (data.message_type === "student_list") {
                        setExistingStudents(data.students);
                    } else if (data.message_type === "analysis_result") {
                        setAnalysisLoading(false);
                        setCurrentAnalysisData(prev => ({
                            ...prev,
                            ...data.result,
                            category: prev?.category && prev.category !== 'VOCAB_GAP' ? prev.category : data.result.category
                        }));
                    } else if (data.message_type === "system_health") {
                        alert(`System Health:\nCPU: ${data.data.cpu_percent}%\nMemory: ${data.data.memory_usage}%`);
                    } else if (data.message_type === "notification") {
                        alert(data.text);
                    } else if (data.message_type === "session_ended") {
                        setConnectionStatus("Ended");
                        alert("Session has been ended by the server.");
                    }
                };

                return () => socket.close();
            }, []);

            // --- HANDLERS ---
            const handlePartial = (text) => {
                setItems(prev => {
                    const newItems = [...prev];
                    const liveList = [...newItems[0].items];
                    const lastItem = liveList[liveList.length - 1];
                    
                    if (lastItem && lastItem.isPartial) {
                        liveList[liveList.length - 1] = { ...lastItem, text: text + "..." };
                    } else {
                        liveList.push({ 
                            id: 'partial-' + Date.now(),
                            text: text + "...", 
                            isPartial: true,
                            speaker: null
                        });
                    }
                    newItems[0] = { ...newItems[0], items: liveList };
                    return newItems;
                });
            };

            const handleFinal = (data) => {
                setItems(prev => {
                    const newItems = [...prev];
                    let liveList = [...newItems[0].items];
                    const partialIndex = liveList.findIndex(item => item.isPartial);
                    
                    const newItem = {
                        id: 'turn-' + data.turn_order,
                        text: data.text,
                        speaker: data.speaker || "Unknown",
                        isPartial: false,
                        fullData: data,
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };

                    if (partialIndex !== -1) {
                        liveList[partialIndex] = newItem;
                    } else {
                        liveList.push(newItem);
                    }
                    
                    newItems[0] = { ...newItems[0], items: liveList };
                    return newItems;
                });
            };

            const handleCardClick = (item) => {
                if (item.isPartial) return;
                setPendingCardItem(item);
                setIsAnalysisOpen(true);
                setAnalysisLoading(true);
                setCurrentAnalysisData({ 
                    detectedTrigger: item.text,
                    category: 'VOCAB_GAP' 
                }); 

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        message_type: "analyze_turn",
                        text: item.text,
                        turn_id: item.id
                    }));
                } else {
                    setAnalysisLoading(false);
                }
            };

            const handleAnalysisSave = (formData) => {
                if (!pendingCardItem) return;
                setItems(prev => {
                    const newItems = [...prev];
                    newItems[1].items.push({ 
                        ...pendingCardItem, 
                        id: pendingCardItem.id + '-card-' + Date.now(),
                        analysis: formData
                    });
                    return newItems;
                });
                setIsAnalysisOpen(false);
                setPendingCardItem(null);
            };

            // --- BUTTON ACTIONS ---
            const handleEndSession = () => {
                if (confirm("Are you sure you want to end the session?")) {
                    if (ws) ws.close();
                    setConnectionStatus("Ended");
                }
            };

            const handleArchive = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message_type: "archive_session" }));
                }
            };

            const handleSystemHealth = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message_type: "get_system_health" }));
                }
            };

            const handleExport = (format) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ message_type: "export_session", format }));
                }
                setIsExportOpen(false);
            };

            // --- RENDER ---
            return (
                <div className="flex flex-col h-full bg-black">
                    {/* HEADER */}
                    <header className="px-6 py-4 glass-panel flex items-center justify-between sticky top-0 z-20">
                        <div className="flex items-center space-x-6">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                                    <span className="material-symbols-rounded text-white text-lg">waves</span>
                                </div>
                                <h1 className="text-xl font-semibold tracking-tight text-white">Semantic Surf</h1>
                            </div>
                            
                            <div className="h-6 w-px bg-white/10"></div>

                            <div className="flex items-center space-x-3">
                                <div className={`flex items-center px-3 py-1 rounded-full text-xs font-medium ${connectionStatus === 'Connected' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>
                                    <span className={`w-1.5 h-1.5 rounded-full mr-2 ${connectionStatus === 'Connected' ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></span>
                                    {connectionStatus === 'Connected' ? 'LIVE' : connectionStatus.toUpperCase()}
                                </div>
                                
                                <div className="relative group">
                                    <select 
                                        className="appearance-none bg-transparent text-sm font-medium text-gray-300 pl-2 pr-6 py-1 cursor-pointer focus:outline-none hover:text-white transition-colors"
                                        value={studentName}
                                        onChange={(e) => setStudentName(e.target.value)}
                                    >
                                        <option value="Unknown" disabled>Select Student...</option>
                                        {existingStudents.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <span className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500 material-symbols-rounded text-sm">expand_more</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center space-x-2">
                            <ControlButton icon="archive" label="Archive" onClick={handleArchive} />
                            <ControlButton icon="download" label="Export" onClick={() => setIsExportOpen(true)} />
                            <ControlButton icon="ecg_heart" label="Health" onClick={handleSystemHealth} />
                            <button onClick={handleEndSession} className="ml-2 px-4 py-1.5 text-xs font-semibold text-white bg-red-500/80 hover:bg-red-500 rounded-full transition-all shadow-lg shadow-red-500/20 backdrop-blur-sm">
                                End Session
                            </button>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-grow flex overflow-hidden relative">
                        {/* TRANSCRIPT AREA */}
                        <section className="flex-1 flex flex-col relative">
                            <div className="flex-1 overflow-y-auto p-4 space-y-1 scrollbar-hide">
                                <TranscriptList items={items[0].items} onCardClick={handleCardClick} />
                            </div>
                            
                            {/* INPUT AREA (Placeholder for future) */}
                            <div className="p-4 glass-panel border-t border-white/5">
                                <div className="flex items-center space-x-3 bg-white/5 rounded-2xl px-4 py-3 border border-white/5 focus-within:border-blue-500/50 transition-colors">
                                    <span className="material-symbols-rounded text-gray-500">mic</span>
                                    <input type="text" placeholder="Listening..." className="bg-transparent border-none outline-none text-sm text-white w-full placeholder-gray-600" disabled />
                                    <span className="material-symbols-rounded text-gray-500">graphic_eq</span>
                                </div>
                            </div>
                        </section>

                        {/* SIDEBAR (Tasks & Notes) */}
                        <aside className="w-80 glass-panel border-l border-white/10 flex flex-col z-10">
                            <div className="p-4 border-b border-white/5 flex items-center justify-between">
                                <h2 className="text-sm font-semibold text-gray-200">Action Items</h2>
                                <span className="text-xs text-gray-500 bg-white/5 px-2 py-0.5 rounded-full">{items[1].items.length}</span>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-3 space-y-2">
                                {items[1].items.length === 0 && (
                                    <div className="flex flex-col items-center justify-center h-40 text-gray-600 space-y-2">
                                        <span className="material-symbols-rounded text-3xl opacity-20">task</span>
                                        <p className="text-xs">No tasks yet</p>
                                    </div>
                                )}
                                {items[1].items.map((item, idx) => (
                                    <TaskItem key={item.id || idx} item={item} />
                                ))}
                            </div>

                            <div className="p-4 border-t border-white/5 bg-black/20">
                                <div className="flex items-center space-x-2 mb-2">
                                    <span className="material-symbols-rounded text-xs text-gray-500">edit_note</span>
                                    <span className="text-xs font-medium text-gray-400">Session Notes</span>
                                </div>
                                <textarea 
                                    className="w-full h-32 bg-transparent text-sm text-gray-300 placeholder-gray-700 resize-none outline-none font-mono leading-relaxed" 
                                    placeholder="Type notes here..."
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                ></textarea>
                            </div>
                        </aside>
                    </main>

                    {/* MODALS */}
                    <AnalysisModal 
                        isOpen={isAnalysisOpen} 
                        onClose={() => setIsAnalysisOpen(false)}
                        onSave={handleAnalysisSave}
                        isLoading={analysisLoading}
                        initialData={currentAnalysisData}
                    />
                    
                    <ExportModal
                        isOpen={isExportOpen}
                        onClose={() => setIsExportOpen(false)}
                        onExport={handleExport}
                    />
                </div>
            );
        }

        // --- COMPONENTS ---

        function ControlButton({ icon, label, onClick }) {
            return (
                <button onClick={onClick} className="flex items-center space-x-1.5 px-3 py-1.5 rounded-lg hover:bg-white/10 transition-colors group">
                    <span className="material-symbols-rounded text-gray-400 group-hover:text-white text-lg">{icon}</span>
                    <span className="text-xs font-medium text-gray-400 group-hover:text-white">{label}</span>
                </button>
            );
        }

        function TranscriptList({ items, onCardClick }) {
            const bottomRef = useRef(null);
            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: "smooth" }); }, [items]);

            return (
                <div className="flex flex-col space-y-1 pb-4">
                    {items.map((item, index) => (
                        <TranscriptItem key={item.id || index} item={item} onClick={() => onCardClick(item)} />
                    ))}
                    <div ref={bottomRef} />
                </div>
            );
        }

        function TranscriptItem({ item, onClick }) {
            const isTutor = item.speaker && (item.speaker.includes("Aaron") || item.speaker === "A");
            
            if (item.isPartial) {
                return (
                    <div className="flex justify-center py-2 opacity-50">
                        <span className="text-xs text-gray-500 animate-pulse font-mono">{item.text}</span>
                    </div>
                );
            }

            return (
                <motion.div 
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className={`flex w-full group ${isTutor ? 'justify-end' : 'justify-start'}`}
                    onClick={onClick}
                >
                    <div className={`max-w-[70%] flex flex-col ${isTutor ? 'items-end' : 'items-start'}`}>
                        {/* Bubble */}
                        <div className={`
                            px-4 py-2 rounded-2xl text-[15px] leading-relaxed cursor-pointer transition-all shadow-sm
                            ${isTutor 
                                ? 'bg-[#0A84FF] text-white rounded-tr-sm hover:bg-[#007AFF]' 
                                : 'bg-[#1C1C1E] text-gray-100 rounded-tl-sm hover:bg-[#2C2C2E] border border-white/5'}
                        `}>
                            {item.text}
                        </div>
                        
                        {/* Metadata (Hidden by default, visible on hover) */}
                        <div className={`
                            flex items-center space-x-2 mt-1 px-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200
                            ${isTutor ? 'flex-row-reverse space-x-reverse' : 'flex-row'}
                        `}>
                            <span className="text-[10px] font-medium text-gray-500 uppercase tracking-wider">
                                {isTutor ? 'Project Lead' : 'Team Analyst'}
                            </span>
                            <span className="text-[10px] text-gray-600">â€¢</span>
                            <span className="text-[10px] text-gray-600 font-mono">
                                {item.timestamp || "Now"}
                            </span>
                        </div>
                    </div>
                </motion.div>
            );
        }

        function TaskItem({ item }) {
            const analysis = item.analysis || {};
            return (
                <div className="group bg-[#1C1C1E] hover:bg-[#2C2C2E] rounded-xl p-3 border border-white/5 hover:border-blue-500/30 transition-all cursor-pointer">
                    <div className="flex items-start justify-between mb-1">
                        <span className="text-[10px] font-bold text-blue-400 uppercase tracking-wider bg-blue-500/10 px-1.5 py-0.5 rounded">
                            {analysis.category || "TASK"}
                        </span>
                        <span className="text-[10px] text-gray-600 font-mono">{item.timestamp}</span>
                    </div>
                    <p className="text-sm text-gray-200 leading-snug">
                        {analysis.suggestedCorrection || item.text}
                    </p>
                </div>
            );
        }

        function AnalysisModal({ isOpen, onClose, onSave, isLoading, initialData }) {
            const [formData, setFormData] = useState({ category: 'VOCAB_GAP', suggestedCorrection: '', explanation: '', detectedTrigger: '' });
            
            useEffect(() => {
                if (initialData) setFormData(prev => ({ ...prev, ...initialData }));
            }, [initialData]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <motion.div 
                        initial={{ scale: 0.95, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="bg-[#1C1C1E] border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl shadow-black/50"
                    >
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-semibold text-white">Create Card</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-white material-symbols-rounded">close</button>
                        </div>

                        {isLoading ? (
                            <div className="py-8 flex flex-col items-center justify-center space-y-3">
                                <div className="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                <p className="text-sm text-gray-500">Analyzing context...</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-medium text-gray-500 uppercase tracking-wider ml-1">Original Text</label>
                                    <div className="mt-1 p-3 bg-black/30 rounded-xl text-gray-300 text-sm italic border border-white/5">
                                        "{formData.detectedTrigger}"
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-medium text-gray-500 uppercase tracking-wider ml-1">Category</label>
                                        <select 
                                            className="mt-1 w-full bg-[#2C2C2E] text-white text-sm rounded-lg px-3 py-2.5 outline-none focus:ring-1 focus:ring-blue-500 border border-white/5"
                                            value={formData.category}
                                            onChange={e => setFormData({...formData, category: e.target.value})}
                                        >
                                            <option value="VOCAB_GAP">Vocabulary</option>
                                            <option value="GRAMMAR_ERR">Grammar</option>
                                            <option value="PRONUNCIATION">Pronunciation</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium text-gray-500 uppercase tracking-wider ml-1">Correction</label>
                                        <input 
                                            className="mt-1 w-full bg-[#2C2C2E] text-white text-sm rounded-lg px-3 py-2.5 outline-none focus:ring-1 focus:ring-blue-500 border border-white/5"
                                            value={formData.suggestedCorrection}
                                            onChange={e => setFormData({...formData, suggestedCorrection: e.target.value})}
                                            placeholder="Correction..."
                                        />
                                    </div>
                                </div>

                                <div className="pt-4 flex justify-end space-x-3">
                                    <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors">Cancel</button>
                                    <button onClick={() => onSave(formData)} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold rounded-full shadow-lg shadow-blue-600/20 transition-all transform active:scale-95">
                                        Save Card
                                    </button>
                                </div>
                            </div>
                        )}
                    </motion.div>
                </div>
            );
        }

        function ExportModal({ isOpen, onClose, onExport }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                    <motion.div 
                        initial={{ scale: 0.95, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="bg-[#1C1C1E] border border-white/10 rounded-2xl p-6 w-80 shadow-2xl"
                    >
                        <h3 className="text-lg font-semibold text-white text-center mb-6">Export Session</h3>
                        <div className="space-y-3">
                            <button onClick={() => onExport('json')} className="w-full flex items-center justify-between p-4 bg-[#2C2C2E] hover:bg-[#3A3A3C] rounded-xl transition-colors group">
                                <span className="font-medium text-gray-200">JSON Format</span>
                                <span className="material-symbols-rounded text-gray-500 group-hover:text-white">data_object</span>
                            </button>
                            <button onClick={() => onExport('markdown')} className="w-full flex items-center justify-between p-4 bg-[#2C2C2E] hover:bg-[#3A3A3C] rounded-xl transition-colors group">
                                <span className="font-medium text-gray-200">Markdown</span>
                                <span className="material-symbols-rounded text-gray-500 group-hover:text-white">markdown</span>
                            </button>
                        </div>
                        <button onClick={onClose} className="w-full mt-6 text-sm text-gray-500 hover:text-white transition-colors">Cancel</button>
                    </motion.div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

