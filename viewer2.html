<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Semantic Server</title>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amaranth:ital,wght@0,400;0,700;1,400&family=Asap:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
        /* BASE & RESET */
        :root {
            --hue1: 255;
            --hue2: 222;
            --border: 1px;
            --border-color: hsl(var(--hue2), 12%, 20%);
            --radius: 22px;
            --ease: cubic-bezier(0.5, 1, 0.89, 1);
            --fg: oklab(0.9 0 0); /* Foreground approximation */
        }

        body {
            margin: 0;
            background: #08090d box-shadow: inset 0 0 100px black;
            background-image: url(https://assets.codepen.io/13471/abstract-light.jpg), linear-gradient(to right in oklab, hsl(var(--hue2) 50% 75%), hsl(var(--hue1) 50% 75%));
            background-size: cover;
            background-position: center;
            background-blend-mode: hard-light;
            font-family: 'Asap', sans-serif;
            color: #737985;
            overflow: hidden;
            height: 100vh;
        }

        .app-drag-region { -webkit-app-region: drag; }
        .app-no-drag { -webkit-app-region: no-drag; }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 24px;
            box-sizing: border-box;
            gap: 24px;
        }

        /* CARD COMPONENT (The "Menu" Style) */
        .glass-card {
            position: relative;
            border-radius: var(--radius);
            border: var(--border) solid var(--border-color);
            padding: 1.5em;
            background: linear-gradient(235deg, hsl(var(--hue1) 50% 10% / 0.8), hsl(var(--hue1) 50% 10% / 0) 33%), 
                        linear-gradient(45deg , hsl(var(--hue2) 50% 10% / 0.8), hsl(var(--hue2) 50% 10% / 0) 33%), 
                        linear-gradient(hsl(220deg 25% 4.8% / 0.66));
            backdrop-filter: blur(12px);
            box-shadow: hsl(var(--hue2) 50% 2%) 0px 10px 16px -8px, hsl(var(--hue2) 50% 4%) 0px 20px 36px -14px;
            transition: all 0.5s var(--ease);
        }

        /* SHINE & GLOW EFFECTS */
        .glass-card .shine {
            pointer-events: none;
            border-radius: inherit;
            border: 1px solid transparent;
            position: absolute;
            inset: -1px;
            z-index: 1;
            background: conic-gradient(
                from var(--conic, -45deg) at center in oklch,
                transparent 12%, hsl(var(--hue1), 80%, 60%), transparent 50%
            ) border-box;
            mask: linear-gradient(transparent), linear-gradient(black);
            mask-composite: subtract;
            mask-clip: padding-box, border-box;
            animation: glow 2s var(--ease) both;
        }

        .glass-card .glow {
            pointer-events: none;
            position: absolute;
            inset: -20px;
            border: 20px solid transparent;
            border-radius: 40px;
            mask: url('https://assets.codepen.io/13471/noise-base.png');
            mask-mode: luminance;
            mask-size: 29%;
            filter: blur(12px) saturate(1.25) brightness(0.5);
            mix-blend-mode: plus-lighter;
            z-index: 3;
            animation: glow 2s var(--ease) both;
            animation-delay: 0.2s;
        }
        
        .glass-card .glow::before {
            content: ""; position: absolute; inset: 0;
            background: conic-gradient(from -45deg at center, transparent 0%, hsl(var(--hue1), 95%, 60%), transparent 50%);
            mask: linear-gradient(black), linear-gradient(transparent);
            mask-composite: exclude;
        }

        @keyframes glow {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes flash {
            0% { opacity: 1; background-color: white; }
            100% { opacity: 1; }
        }

        /* CONTROLS STYLING */
        input.glass-input, select.glass-input {
            width: 100%;
            height: 48px;
            color: hsl(0 0 100% / 0.8);
            font-family: 'Asap', sans-serif;
            font-size: 14px;
            font-weight: 300;
            border: 1px solid hsl(var(--hue2) 13% 18.5% / 0.5);
            background: linear-gradient(to bottom, hsl(var(--hue1) 20% 20% / 0.1) 0%, hsl(var(--hue1) 50% 50% / 0.2) 100%);
            border-radius: 12px;
            padding: 0 16px;
            outline: none;
            transition: all 0.3s var(--ease);
            appearance: none;
        }
        input.glass-input:focus, select.glass-input:focus {
            border-color: hsl(var(--hue1) 50% 60% / 0.5);
            background-color: hsl(var(--hue1) 20% 20% / 0.3);
            box-shadow: 0 0 20px hsl(var(--hue1) 50% 60% / 0.1);
        }

        /* BUTTONS via LI style */
        .glass-btn {
            position: relative;
            padding: 0 1.5em;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            border-radius: 12px;
            border: 1px solid transparent;
            background: linear-gradient(90deg in oklch, hsl(var(--hue2) 29% 13% / 0.3), hsl(var(--hue2) 30% 15% / 0.3));
            color: #bdc1c6;
            cursor: pointer;
            transition:all 0.3s;
            font-family: 'Asap', sans-serif;
            font-weight: 500;
            user-select: none;
        }
        
        .glass-btn:hover {
            color: white;
            background: linear-gradient(90deg in oklch, hsl(var(--hue1) 30% 20% / 0.6), hsl(var(--hue1) 40% 30% / 0.6));
            box-shadow: 0 0 15px hsl(var(--hue1) 50% 50% / 0.2);
        }

        .glass-btn.active {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        
        .glass-btn.danger {
            background: linear-gradient(90deg, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        /* LAYOUTS */
        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .transcript-area {
            flex: 1;
            overflow-y: auto;
            border-radius: var(--radius);
            padding: 2px; /* For scrollbar breathing room */
        }
        
        .transcript-bubble {
            margin-bottom: 24px;
            animation: slideUp 0.4s var(--ease);
        }
        
        .speaker {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: hsl(var(--hue2) 70% 70%);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .speaker::before {
            content:''; width: 6px; height: 6px; background: hsl(var(--hue2) 70% 70%); border-radius: 50%;
            box-shadow: 0 0 8px hsl(var(--hue2) 70% 70%);
        }
        
        .text-content {
            font-size: 18px;
            line-height: 1.6;
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-weight: 300;
        }
        
        .partial {
            color: #94a3b8;
            opacity: 0.7;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: hsl(var(--hue2) 15% 30%); 
            border-radius: 4px; 
            border: 2px solid #08090d;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            // STATE
            const [isConnected, setIsConnected] = useState(false);
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState('');
            const [transcript, setTranscript] = useState([]);
            const [isSessionActive, setIsSessionActive] = useState(false);
            const [wpm, setWpm] = useState(0);
            const [isPinned, setIsPinned] = useState(false);
            const wsRef = useRef(null);
            const transcriptEndRef = useRef(null);

            // WEBSOCKET
            useEffect(() => {
                const connect = () => {
                    const ws = new WebSocket('ws://localhost:8765');
                    wsRef.current = ws;

                    ws.onopen = () => {
                        setIsConnected(true);
                        ws.send(JSON.stringify({ type: 'get_students' }));
                    };

                    ws.onmessage = (e) => {
                        const data = JSON.parse(e.data);
                        handleMessage(data);
                    };

                    ws.onclose = () => {
                        setIsConnected(false);
                        setTimeout(connect, 2000);
                    };
                };
                connect();
            }, []);

            const handleMessage = (data) => {
                if (data.message_type === 'student_list') {
                    setStudents(data.students || []);
                } else if (data.message_type === 'transcript' || data.message_type === 'partial') {
                    setTranscript(prev => {
                        // Logic to merge partials or add new finalized turns
                        const newTurn = {
                            id: data.turn_id || Date.now(),
                            speaker: data.speaker || 'Unknown',
                            text: data.text,
                            isPartial: data.message_type === 'partial'
                        };
                        
                        // Replace partial if exists, or add new
                        const last = prev[prev.length - 1];
                        if (last && last.isPartial) {
                            // If incoming is finalized or newer partial, replace/update
                             return [...prev.slice(0, -1), newTurn];
                        }
                        return [...prev, newTurn];
                    });
                    
                    if (data.speaking_rate_wpm) setWpm(Math.round(data.speaking_rate_wpm));
                }
            };

            // AUTO-SELECT ANDREA
            useEffect(() => {
                if (students.includes("Andrea") && !selectedStudent) {
                    setSelectedStudent("Andrea");
                }
            }, [students]);

            // PINNED
            useEffect(() => {
                const saved = localStorage.getItem('isPinned') === 'true';
                setIsPinned(saved);
                if (saved && window.electronAPI) window.electronAPI.setAlwaysOnTop(true);
            }, []);

            const togglePin = () => {
                const newVal = !isPinned;
                setIsPinned(newVal);
                localStorage.setItem('isPinned', newVal);
                if (window.electronAPI) window.electronAPI.setAlwaysOnTop(newVal);
            };

            // SESSION CONTROL (Using WS not Fetch)
            const toggleSession = () => {
                if (!selectedStudent || !wsRef.current) return;

                if (isSessionActive) {
                    wsRef.current.send(JSON.stringify({ message_type: 'end_session' }));
                    setIsSessionActive(false);
                    setTranscript([]); // clear on stop
                } else {
                    wsRef.current.send(JSON.stringify({ 
                        message_type: 'start_session', 
                        student_name: selectedStudent 
                    }));
                    setIsSessionActive(true);
                }
            };

            // SCROLL
            useEffect(() => {
                transcriptEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [transcript]);

            return (
                <div id="app">
                    
                    {/* HEADER CARD - The "Menu" Aesthetic */}
                    <div className="glass-card app-drag-region">
                        <div className="shine"></div>
                        <div className="glow"></div>
                        
                        <div className="header-row" style={{position: 'relative', zIndex: 10}}>
                            {/* BRAND */}
                            <div className="flex items-center gap-3">
                                <div style={{
                                    width:40, height:40, background:'linear-gradient(135deg, hsl(var(--hue1) 60% 60%), hsl(var(--hue2) 60% 60%))',
                                    borderRadius:12, display:'flex', alignItems:'center', justifyContent:'center',
                                    color:'#fff', fontWeight:'bold', boxShadow:'0 0 15px hsl(var(--hue1) 50% 50% / 0.5)'
                                }}>S</div>
                                <div>
                                    <h1 style={{fontSize:18, margin:0, color:'white', fontWeight:600}}>Semantic Surfer</h1>
                                    <div style={{display:'flex', gap:8, fontSize:10, color:'hsl(var(--hue2) 30% 60%)', marginTop:4}}>
                                        <span style={{color: isConnected ? '#4ade80' : '#f87171'}}>‚óè SYSTEM</span>
                                        <span style={{color: '#4ade80'}}>‚óè CLOUD</span>
                                    </div>
                                </div>
                            </div>

                            {/* CONTROLS */}
                            <div className="flex items-center gap-4 app-no-drag">
                                
                                {/* STUDENT SELECT */}
                                <div style={{position:'relative', width:220}}>
                                    <select 
                                        className="glass-input" 
                                        value={selectedStudent}
                                        onChange={e => setSelectedStudent(e.target.value)}
                                        style={{cursor:'pointer'}}
                                    >
                                        <option value="">Select Student...</option>
                                        {students.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <div style={{position:'absolute', right:16, top:16, pointerEvents:'none', color:'white', opacity:0.5}}>‚ñº</div>
                                </div>

                                {/* TOGGLE BUTTON (Replaces Clay Toggle) */}
                                <button 
                                    className={`glass-btn ${isSessionActive ? 'active' : ''}`}
                                    onClick={toggleSession}
                                    style={{minWidth: 140, justifyContent:'space-between'}}
                                >
                                    <span>{isSessionActive ? 'ON AIR' : 'OFF AIR'}</span>
                                    <div style={{
                                        width:8, height:8, borderRadius:'50%', 
                                        background: isSessionActive ? 'white' : 'rgba(255,255,255,0.2)',
                                        boxShadow: isSessionActive ? '0 0 10px white' : 'none'
                                    }}></div>
                                </button>

                                {/* WPM */}
                                <div className="glass-btn" style={{width: 80, cursor:'default'}}>
                                    {wpm} <small style={{opacity:0.5, marginLeft:4}}>WPM</small>
                                </div>

                                {/* PIN */}
                                <button 
                                    className={`glass-btn ${isPinned ? 'active' : ''}`} 
                                    onClick={togglePin}
                                    style={{width: 48, padding:0}}
                                    title="Always on Top"
                                >
                                    üìå
                                </button>
                                
                                {/* COMMIT/SEND */}
                                <button className="glass-btn" style={{width: 48, padding:0}}>‚û§</button>
                            </div>
                        </div>
                    </div>

                    {/* TRANSCRIPT AREA */}
                    <div className="glass-card transcript-area">
                         <div className="shine" style={{opacity:0.3}}></div>
                         <div style={{position:'relative', zIndex:10, padding: 10}}>
                            {transcript.length === 0 && (
                                <div style={{textAlign:'center', padding:40, opacity:0.3, fontStyle:'italic'}}>
                                    Ready to receive audio stream...
                                </div>
                            )}
                            {transcript.map((turn, i) => (
                                <div key={i} className="transcript-bubble">
                                    <div className="speaker">{turn.speaker}</div>
                                    <div className={`text-content ${turn.isPartial ? 'partial' : ''}`}>
                                        {turn.text}
                                    </div>
                                </div>
                            ))}
                            <div ref={transcriptEndRef} />
                         </div>
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>