<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Project Sentinel Dashboard</title>
    
    <!-- React & Framer Motion -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght,FILL@300,1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <style type="text/tailwindcss">
        @layer base {
            html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        }
        :root {
            --bg-primary: #000000;
            --glass-panel: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        .glass-panel {
            background-color: var(--glass-panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }
        /* Hide scrollbar for clean look */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col overflow-hidden">
    <div id="root" class="flex flex-col h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- MODULE: DashboardClient (Networking Layer) ---
        class DashboardClient {
            constructor(url, handlers) {
                this.url = url;
                this.handlers = handlers;
                this.socket = null;
                this.reconnectInterval = 3000;
            }

            connect(studentName) {
                this.socket = new WebSocket(this.url);

                this.socket.onopen = () => {
                    this.handlers.onStatusChange("Connected");
                    this.socket.send(JSON.stringify({
                        message_type: "start_session",
                        student_name: studentName
                    }));
                };

                this.socket.onclose = () => {
                    this.handlers.onStatusChange("Disconnected");
                    setTimeout(() => this.connect(studentName), this.reconnectInterval);
                };

                this.socket.onerror = () => this.handlers.onStatusChange("Error");

                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.error("Parse Error:", e);
                    }
                };
            }

            handleMessage(data) {
                switch(data.message_type) {
                    case "partial":
                        this.handlers.onPartial(data.text);
                        break;
                    case "transcript":
                        this.handlers.onTurn(data);
                        break;
                    case "analysis_result":
                        this.handlers.onAnalysis(data);
                        break;
                    case "student_list":
                        this.handlers.onStudentList(data.students);
                        break;
                    case "system_health":
                        this.handlers.onHealth(data.data);
                        break;
                    default:
                        console.log("Unknown message:", data);
                }
            }

            sendMessage(type, payload = {}) {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({ message_type: type, ...payload }));
                }
            }
        }

        // --- MODULE: StudentContext (State Management) ---
        const StudentContext = createContext();

        function StudentProvider({ children }) {
            const [studentName, setStudentName] = useState("Unknown");
            const [connectionStatus, setConnectionStatus] = useState("Disconnected");
            const [turns, setTurns] = useState([]);
            const [activeTurn, setActiveTurn] = useState(null); // For partials
            const [actionableTasks, setActionableTasks] = useState([]);
            const [studentsList, setStudentsList] = useState([]);

            const clientRef = useRef(null);

            // Initialize DashboardClient
            useEffect(() => {
                const handlers = {
                    onStatusChange: setConnectionStatus,
                    onPartial: (text) => setActiveTurn({ text, isPartial: true }),
                    onTurn: (data) => {
                        setActiveTurn(null);
                        setTurns(prev => [...prev, { ...data, id: 'turn-' + Date.now() }]);
                        // Auto-analyze if needed, or backend pushes it
                    },
                    onAnalysis: (data) => {
                         // Update the specific turn or add to tasks if it's new
                         if (data.result && !data.result.error) {
                             setActionableTasks(prev => [data.result, ...prev]);
                         }
                    },
                    onStudentList: setStudentsList,
                    onHealth: (data) => console.log("Health:", data)
                };

                clientRef.current = new DashboardClient("ws://localhost:8765", handlers);
                clientRef.current.connect(studentName);

                return () => { if(clientRef.current.socket) clientRef.current.socket.close(); };
            }, [studentName]);

            const analyzeTurn = (text, turnId) => {
                clientRef.current.sendMessage("analyze_turn", { text, turn_id: turnId });
            };

            const value = {
                studentName, setStudentName,
                connectionStatus,
                turns, activeTurn,
                actionableTasks,
                studentsList,
                analyzeTurn
            };

            return <StudentContext.Provider value={value}>{children}</StudentContext.Provider>;
        }

        // --- COMPONENTS ---

        function Header() {
            const { connectionStatus, studentName, setStudentName, studentsList } = useContext(StudentContext);

            return (
                <header className="px-6 py-4 glass-panel flex items-center justify-between sticky top-0 z-20">
                    <div className="flex items-center space-x-6">
                        <h1 className="text-2xl font-bold tracking-tight text-[#0A84FF]">Project Sentinel Dashboard</h1>

                        <div className={`flex items-center px-3 py-1 rounded-full text-xs font-bold ${connectionStatus === 'Connected' ? 'bg-[#30D158] text-black' : 'bg-red-500 text-white'}`}>
                            {connectionStatus === 'Connected' ? 'OPERATIONAL' : connectionStatus.toUpperCase()}
                        </div>

                        <span className="text-sm text-gray-400">Project: <span className="text-white font-medium">Phoenix Initiative</span></span>

                        <div className="h-6 w-px bg-white/10 mx-2"></div>

                        <div className="relative group">
                            <select
                                className="appearance-none bg-transparent text-sm font-medium text-gray-300 pl-2 pr-6 py-1 cursor-pointer focus:outline-none hover:text-white transition-colors"
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                            >
                                <option value="Unknown" disabled>Select Student...</option>
                                {studentsList.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <span className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500 material-symbols-rounded text-sm">expand_more</span>
                        </div>
                    </div>

                    <div className="flex items-center space-x-2">
                        <button className="flex items-center space-x-1.5 px-3 py-1.5 rounded-lg hover:bg-white/10 transition-colors">
                            <span className="material-symbols-rounded text-gray-400">archive</span>
                            <span className="text-xs font-medium text-gray-400">Archive</span>
                        </button>
                    </div>
                </header>
            );
        }

        function TaskCard({ task }) {
            return (
                <motion.div
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    className="group bg-[#1C1C1E] hover:bg-[#2C2C2E] rounded-xl p-4 border border-white/5 hover:border-blue-500/30 transition-all mb-3"
                >
                    <div className="flex items-start justify-between mb-2">
                        <span className="text-[10px] font-bold text-blue-400 uppercase tracking-wider bg-blue-500/10 px-2 py-0.5 rounded">
                            {task.category || "General"}
                        </span>
                    </div>
                    <div className="mb-2">
                        <p className="text-xs text-gray-500 mb-1">Correction:</p>
                        <p className="text-sm text-white font-medium leading-snug">{task.suggestedCorrection}</p>
                    </div>
                    <div>
                        <p className="text-xs text-gray-500 mb-1">Reason:</p>
                        <p className="text-xs text-gray-400 leading-relaxed">{task.explanation}</p>
                    </div>
                </motion.div>
            );
        }

        function ChatBubble({ turn, isPartial }) {
            const isTutor = turn.speaker && (turn.speaker === 'Aaron' || turn.speaker === 'A');
            return (
                <motion.div 
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className={`flex w-full mb-4 ${isTutor ? 'justify-end' : 'justify-start'}`}
                >
                    <div className={`max-w-[70%] flex flex-col ${isTutor ? 'items-end' : 'items-start'}`}>
                        <div className={`
                            px-4 py-2 rounded-2xl text-[15px] leading-relaxed shadow-sm
                            ${isTutor 
                                ? 'bg-[#0A84FF] text-white rounded-tr-sm'
                                : 'bg-[#1C1C1E] text-gray-100 rounded-tl-sm border border-white/5'}
                            ${isPartial ? 'opacity-60 animate-pulse' : ''}
                        `}>
                            {turn.text}
                        </div>
                        <span className="text-[10px] font-medium text-gray-500 uppercase tracking-wider mt-1 px-1">
                            {isTutor ? 'Project Lead' : 'Team Analyst'}
                        </span>
                    </div>
                </motion.div>
            );
        }

        function Dashboard() {
            const { turns, activeTurn, actionableTasks } = useContext(StudentContext);
            const scrollRef = useRef(null);

            useEffect(() => {
                if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [turns, activeTurn]);

            return (
                <main className="flex-grow flex overflow-hidden relative">
                    {/* LEFT: CHAT */}
                    <section className="flex-1 flex flex-col relative border-r border-white/10">
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-hide" ref={scrollRef}>
                            {turns.map((t) => <ChatBubble key={t.id} turn={t} />)}
                            {activeTurn && <ChatBubble turn={activeTurn} isPartial={true} />}
                        </div>
                        <div className="p-4 glass-panel border-t border-white/5">
                            <div className="flex items-center space-x-3 bg-white/5 rounded-2xl px-4 py-3">
                                <span className="material-symbols-rounded text-gray-500">mic</span>
                                <span className="text-sm text-gray-400 italic">Listening to audio stream...</span>
                            </div>
                        </div>
                    </section>

                    {/* RIGHT: ACTIONABLE TASKS */}
                    <aside className="w-96 glass-panel flex flex-col z-10 bg-black/50">
                        <div className="p-4 border-b border-white/5 flex items-center justify-between">
                            <h2 className="text-sm font-semibold text-gray-200">Actionable Tasks & Progress</h2>
                            <span className="text-xs text-gray-500 bg-white/5 px-2 py-0.5 rounded-full">{actionableTasks.length}</span>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 scrollbar-hide">
                            {actionableTasks.length === 0 && (
                                <div className="text-center mt-10 opacity-30">
                                    <span className="material-symbols-rounded text-4xl mb-2">task</span>
                                    <p className="text-xs">No actionable tasks detected yet.</p>
                                </div>
                            )}
                            <AnimatePresence>
                                {actionableTasks.map((task, i) => (
                                    <TaskCard key={i} task={task} />
                                ))}
                            </AnimatePresence>
                        </div>
                    </aside>
                </main>
            );
        }

        function App() {
            return (
                <StudentProvider>
                    <div className="flex flex-col h-full bg-black">
                        <Header />
                        <Dashboard />
                    </div>
                </StudentProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
