<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Semantic Surfer - Liquid Glass</title>
    
    <!-- React & Framer Motion -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Google+Sans+Flex:opsz,wght@6..144,1..1000&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght,FILL@300,1&amp;display=swap" rel="stylesheet"/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <style type="text/tailwindcss">
        @layer base {
            html { font-family: "Google Sans Flex", -apple-system, sans-serif; }
        }

        /* --- LIQUID GLASS THEME --- */
        :root {
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.15);
            --bubble-sent: #FF453A;
            --bubble-received: #1C1C1E;
        }

        /* Animated Background */
        .liquid-bg {
            background: radial-gradient(circle at 0% 0%, #0f172a, #330c0c, #1f1202);
            background-size: 400% 400%;
            animation: gradientBG 30s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Electron Window Controls */
        .app-drag-region { -webkit-app-region: drag; }
        .app-no-drag { -webkit-app-region: no-drag; }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glass Utilities */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-bubble {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- LIQUID DROPDOWN STYLES --- */
        .drop {
            position: relative;
            cursor: pointer;
            z-index: 50;
        }

        .drop .label {
            color: white;
            padding: 8px 20px;
            background: rgba(255,255,255,0.08);
            box-shadow: inset 0.5px 0.5px 0 rgba(255,255,255,0.2), inset -0.5px -0.5px 0 rgba(255,255,255,0.2);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drop .options {
            position: absolute;
            color: white;
            padding: 8px;
            top: 0;
            left: 0;
            width: 100%;
            min-width: 180px;
            background: rgba(20, 20, 20, 0.9);
            box-shadow: inset 0.5px 0.5px 0 rgba(255,255,255,0.2), inset -0.5px -0.5px 0 rgba(255,255,255,0.2), 0 10px 40px rgba(0,0,0,0.5);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.8) translateY(-20%);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
        }

        .drop .options .option-item {
            padding: 10px 16px;
            filter: blur(5px);
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 12px;
            cursor: pointer;
            opacity: 0;
            transform: translateX(-10px);
        }

        .drop .options .option-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Active State for Dropdown */
        .drop.liquid .label {
            background: rgba(255,255,255,0.2);
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .drop.liquid .options {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .drop.liquid .options .option-item {
            filter: blur(0);
            opacity: 1;
            transform: translateX(0);
        }

        /* Stagger delays for options */
        .drop.liquid .options .option-item:nth-child(1) { transition-delay: 0.1s; }
        .drop.liquid .options .option-item:nth-child(2) { transition-delay: 0.15s; }
        .drop.liquid .options .option-item:nth-child(3) { transition-delay: 0.2s; }
        .drop.liquid .options .option-item:nth-child(4) { transition-delay: 0.25s; }

    </style>
</head>
<body class="liquid-bg text-white min-h-screen flex flex-col overflow-hidden selection:bg-red-500 selection:text-white">
    <!-- Overlay for readability -->
    <div class="absolute inset-0 bg-black/40 pointer-events-none z-0"></div>

    <div id="root" class="flex flex-col h-screen relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- DASHBOARD CLIENT ---
        class DashboardClient {
            constructor(url, handlers) {
                this.url = url;
                this.handlers = handlers;
                this.socket = null;
                this.reconnectInterval = 3000;
            }

            connect(studentName) {
                this.socket = new WebSocket(this.url);
                this.socket.onopen = () => {
                    this.handlers.onStatusChange("Connected");
                    this.socket.send(JSON.stringify({ message_type: "start_session", student_name: studentName }));
                };
                this.socket.onclose = () => {
                    this.handlers.onStatusChange("Disconnected");
                    setTimeout(() => this.connect(studentName), this.reconnectInterval);
                };
                this.socket.onerror = () => this.handlers.onStatusChange("Error");
                this.socket.onmessage = (event) => {
                    try { this.handleMessage(JSON.parse(event.data)); } catch (e) { console.error("Parse Error:", e); }
                };
            }

            handleMessage(data) {
                switch(data.message_type) {
                    case "partial": this.handlers.onPartial(data.text); break;
                    case "transcript": this.handlers.onTurn(data); break;
                    case "analysis_result": this.handlers.onAnalysis(data); break;
                    case "student_list": this.handlers.onStudentList(data.students); break;
                    case "system_health": this.handlers.onHealth(data.data); break;
                }
            }

            sendMessage(type, payload = {}) {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({ message_type: type, ...payload }));
                }
            }
        }

        // --- CONTEXT ---
        const StudentContext = createContext();

        function StudentProvider({ children }) {
            const [studentName, setStudentName] = useState("Unknown");
            const [connectionStatus, setConnectionStatus] = useState("Disconnected");
            const [turns, setTurns] = useState([]);
            const [activeTurn, setActiveTurn] = useState(null);
            const [actionableTasks, setActionableTasks] = useState([]); // These are the "Marked" items
            const [studentsList, setStudentsList] = useState([]);
            const clientRef = useRef(null);

            useEffect(() => {
                const handlers = {
                    onStatusChange: setConnectionStatus,
                    onPartial: (text) => setActiveTurn({ text, isPartial: true }),
                    onTurn: (data) => {
                        setActiveTurn(null);
                        setTurns(prev => [...prev, { ...data, id: 'turn-' + Date.now() + Math.random() }]);
                    },
                    onAnalysis: (data) => {
                         // Backend analysis results (optional usage)
                         if (data.result && !data.result.error) {
                             // We might not use this for the "marking" flow, but keeping it for compatibility
                         }
                    },
                    onStudentList: setStudentsList,
                    onHealth: (data) => console.log("Health:", data)
                };

                clientRef.current = new DashboardClient("ws://localhost:8765", handlers);
                clientRef.current.connect(studentName);

                // Fetch initial list
                setTimeout(() => clientRef.current.sendMessage("get_students"), 1000);

                return () => { if(clientRef.current.socket) clientRef.current.socket.close(); };
            }, [studentName]);

            const addTask = (text) => {
                const newTask = {
                    id: Date.now(),
                    text: text,
                    category: "Pending Review",
                    notes: ""
                };
                setActionableTasks(prev => [newTask, ...prev]);
            };

            const toggleAlwaysOnTop = () => {
                if (window.electron && window.electron.toggleAlwaysOnTop) {
                    window.electron.toggleAlwaysOnTop();
                }
            };

            const value = {
                studentName, setStudentName,
                connectionStatus,
                turns, activeTurn,
                actionableTasks, setActionableTasks, addTask,
                studentsList
            };
            return <StudentContext.Provider value={value}>{children}</StudentContext.Provider>;
        }

        // --- COMPONENTS ---

        function LiquidDropdown({ options, value, onChange, placeholder = "Select..." }) {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            return (
                <div
                    ref={dropdownRef}
                    className={`drop app-no-drag ${isOpen ? 'liquid' : ''}`}
                    onClick={() => setIsOpen(!isOpen)}
                >
                    <div className="label">
                        <span className="material-symbols-rounded text-lg">person</span>
                        {value === "Unknown" ? placeholder : value}
                        <span className="material-symbols-rounded text-sm ml-auto opacity-50">expand_more</span>
                    </div>
                    <div className="options">
                        <div className="option-item text-xs uppercase tracking-wider opacity-50 px-4 py-2">Select Student</div>
                        {options.map((opt) => (
                            <div
                                key={opt}
                                className="option-item"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onChange(opt);
                                    setIsOpen(false);
                                }}
                            >
                                {opt}
                            </div>
                        ))}
                        {options.length === 0 && <div className="option-item italic opacity-50">No profiles found</div>}
                    </div>
                </div>
            );
        }

        function Header() {
            const { connectionStatus, studentName, setStudentName, studentsList } = useContext(StudentContext);
            const [isAlwaysOnTop, setIsAlwaysOnTop] = useState(true);

            const toggleTop = () => {
                setIsAlwaysOnTop(!isAlwaysOnTop);
                if (window.electron && window.electron.toggleAlwaysOnTop) {
                    window.electron.toggleAlwaysOnTop();
                }
            };

            return (
                <header className="app-drag-region px-6 py-4 flex items-center justify-between sticky top-0 z-50">
                    <div className="flex items-center space-x-6">
                        <div className="glass-panel rounded-full px-5 py-2 flex items-center space-x-3 backdrop-blur-xl bg-white/5 border border-white/10">
                            <div className="w-2 h-2 rounded-full animate-pulse bg-red-500 shadow-[0_0_10px_#ef4444]"></div>
                            <h1 className="text-sm font-bold tracking-[0.2em] text-white/90">SEMANTIC SURFER</h1>
                        </div>

                        <LiquidDropdown
                            options={studentsList}
                            value={studentName}
                            onChange={setStudentName}
                        />
                    </div>

                    <div className="flex items-center space-x-2 app-no-drag">
                         <div className={`px-3 py-1 rounded-full text-[10px] font-bold tracking-widest uppercase border ${connectionStatus === 'Connected' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>
                            {connectionStatus === 'Connected' ? 'LIVE' : 'OFFLINE'}
                        </div>

                        <button
                            onClick={toggleTop}
                            className={`glass-button w-8 h-8 rounded-full flex items-center justify-center transition-all ${isAlwaysOnTop ? 'bg-white/20 text-white' : 'text-white/40 hover:text-white'}`}
                            title="Toggle Always On Top"
                        >
                            <span className="material-symbols-rounded text-sm">vertical_align_top</span>
                        </button>
                    </div>
                </header>
            );
        }

        function ChatBubble({ turn, isPartial, onClick }) {
            const isTutor = turn.speaker && (turn.speaker === 'Aaron' || turn.speaker === 'A');

            // SPRING ANIMATION CONFIG
            const springConfig = { type: "spring", stiffness: 400, damping: 25 };

            return (
                <motion.div 
                    initial={{ opacity: 0, y: 20, scale: 0.9 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    transition={springConfig}
                    className={`flex w-full mb-6 relative group ${isTutor ? 'justify-end' : 'justify-start'}`}
                >
                    {/* MOLTEN GLASS UNDERLAY EFFECT */}
                    <div className={`absolute inset-0 blur-xl opacity-30 pointer-events-none transform scale-110 ${isTutor ? 'bg-red-500/20' : 'bg-blue-500/10'}`}></div>

                    <div
                        onClick={() => !isPartial && onClick(turn.text)}
                        className={`
                            relative max-w-[85%] px-6 py-4 rounded-3xl cursor-pointer transition-all duration-300
                            ${isTutor 
                                ? 'bg-gradient-to-br from-[#FF453A] to-[#D6342C] text-white rounded-tr-sm shadow-[0_8px_20px_rgba(255,69,58,0.3)]'
                                : 'glass-bubble text-gray-100 rounded-tl-sm hover:bg-white/10'}
                            ${isPartial ? 'opacity-90' : 'opacity-100'}
                        `}
                    >
                        <p className={`
                            text-[15px] leading-relaxed
                            ${isPartial
                                ? 'font-light italic tracking-wide text-white/80 transform scale-[1.02] origin-left'
                                : 'font-normal'}
                        `}>
                            {turn.text}
                        </p>

                        {/* HOVER ACTION HINT */}
                        {!isPartial && (
                            <div className="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white text-black text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg">
                                MARK
                            </div>
                        )}
                    </div>
                </motion.div>
            );
        }

        function MarkCard({ task, index }) {
            return (
                <motion.div
                    initial={{ opacity: 0, x: 50 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.05 }}
                    className="glass-panel p-4 mb-3 rounded-xl border-l-4 border-l-orange-500 relative group"
                >
                    <div className="flex justify-between items-start mb-2">
                        <span className="text-[10px] font-bold text-orange-400 uppercase tracking-widest">Marked</span>
                        <span className="material-symbols-rounded text-white/20 text-sm cursor-pointer hover:text-red-400">delete</span>
                    </div>
                    <p className="text-sm text-white/90 leading-snug font-light">{task.text}</p>
                    <textarea
                        className="mt-3 w-full bg-black/20 text-xs text-white/70 p-2 rounded border border-white/5 focus:border-orange-500/50 outline-none resize-none"
                        placeholder="Add notes..."
                        rows="1"
                    ></textarea>
                </motion.div>
            );
        }

        function Dashboard() {
            const { turns, activeTurn, actionableTasks, addTask } = useContext(StudentContext);
            const scrollRef = useRef(null);
            const [autoScroll, setAutoScroll] = useState(true);

            // Handle Scroll Logic
            const handleScroll = () => {
                if (scrollRef.current) {
                    const { scrollTop, scrollHeight, clientHeight } = scrollRef.current;
                    // If user is within 50px of bottom, enable autoscroll. Otherwise disable.
                    const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
                    setAutoScroll(isNearBottom);
                }
            };

            // Auto-scroll effect
            useEffect(() => {
                if (autoScroll && scrollRef.current) {
                    scrollRef.current.scrollTo({
                        top: scrollRef.current.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, [turns, activeTurn, autoScroll]);

            const handleBubbleClick = (text) => {
                // 1. Copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    console.log("Copied to clipboard");
                });
                // 2. Add to marked list
                addTask(text);
            };

            return (
                <main className="flex-grow flex overflow-hidden px-6 pb-6 gap-6">
                    {/* LEFT COLUMN: CHAT (Wider 70%) */}
                    <section className="flex-[3] glass-panel rounded-[2rem] flex flex-col relative overflow-hidden backdrop-blur-3xl">
                        <div
                            className="flex-1 overflow-y-auto p-8 scrollbar-hide"
                            ref={scrollRef}
                            onScroll={handleScroll}
                        >
                            {turns.length === 0 && !activeTurn && (
                                <div className="h-full flex flex-col items-center justify-center text-white/20">
                                    <div className="w-20 h-20 rounded-full border border-dashed border-white/20 flex items-center justify-center animate-spin-slow">
                                        <span className="material-symbols-rounded text-4xl">graphic_eq</span>
                                    </div>
                                    <p className="mt-4 text-xs font-light tracking-[0.3em] uppercase">Listening for audio...</p>
                                </div>
                            )}

                            <AnimatePresence>
                                {turns.map((t) => (
                                    <ChatBubble key={t.id} turn={t} onClick={handleBubbleClick} />
                                ))}
                            </AnimatePresence>

                            {activeTurn && (
                                <ChatBubble turn={activeTurn} isPartial={true} />
                            )}
                        </div>

                        {/* Status Bar */}
                        <div className="h-12 border-t border-white/5 flex items-center px-6 justify-between bg-black/20">
                            <div className="flex items-center space-x-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                <span className="text-[10px] text-white/40 font-mono uppercase">System Ready</span>
                            </div>
                            <span className="text-[10px] text-white/20 font-mono">V 2.1 LIQUID</span>
                        </div>
                    </section>

                    {/* RIGHT COLUMN: TASKS (Narrower 30%) */}
                    <aside className="flex-1 glass-panel rounded-[2rem] flex flex-col overflow-hidden bg-black/40">
                        <div className="p-5 border-b border-white/5 bg-white/5">
                            <h2 className="text-xs font-bold text-white/80 tracking-widest uppercase flex items-center gap-2">
                                <span className="material-symbols-rounded text-base text-orange-400">bookmark</span>
                                Marked Items
                            </h2>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 scrollbar-hide space-y-2">
                            <AnimatePresence>
                                {actionableTasks.map((task, i) => (
                                    <MarkCard key={task.id || i} task={task} index={i} />
                                ))}
                            </AnimatePresence>

                            {actionableTasks.length === 0 && (
                                <div className="mt-20 text-center opacity-30 px-6">
                                    <p className="text-xs font-light leading-relaxed">Click any message bubble to mark it for review and copy it to clipboard.</p>
                                </div>
                            )}
                        </div>
                    </aside>
                </main>
            );
        }

        function App() {
            return (
                <StudentProvider>
                    <div className="flex flex-col h-full relative z-10">
                        <Header />
                        <Dashboard />
                    </div>
                </StudentProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
